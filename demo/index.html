<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Financiero Personal a 30 Años</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 105%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .collapsible-options {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .collapsible-options.active {
            max-height: 300px; /* A large enough value */
            opacity: 1;
        }
        #log-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Simulador de Inversión a 30 Años</h1>
            <p class="text-gray-600 mt-2">Planifica tu futuro financiero con una estrategia de DCA Oportunista.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Columna de Controles y Parámetros -->
            <div class="lg:w-1/3 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-4">Configuración de la Simulación</h2>
                
                <!-- Importar / Exportar -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Gestión de Escenarios</h3>
                     <div class="flex gap-2">
                        <button id="import-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2"><i class="fas fa-upload"></i> Importar</button>
                        <button id="export-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </div>

                <!-- Cartera Inicial -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Cartera Inicial</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="initial-rv" class="block text-sm font-medium text-gray-700">Renta Variable (RV)</label>
                            <input type="number" id="initial-rv" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="53000">
                        </div>
                        <div>
                            <label for="initial-rf" class="block text-sm font-medium text-gray-700">Renta Fija (RF)</label>
                            <input type="number" id="initial-rf" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="31000">
                        </div>
                        <div>
                            <label for="initial-cash" class="block text-sm font-medium text-gray-700">Liquidez / Ahorro</label>
                            <input type="number" id="initial-cash" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="91000">
                        </div>
                    </div>
                </div>

                <!-- Plan de Aportaciones -->
                 <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Plan de Aportaciones (DCA)</h3>
                     <div class="space-y-3">
                        <div class="flex gap-2">
                             <div class="w-1/2">
                                <label for="future-savings" class="block text-sm font-medium text-gray-700">Ahorro extra total (€)</label>
                                <input type="number" id="future-savings" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="20000">
                            </div>
                            <div class="w-1/2">
                                <label for="future-savings-years" class="block text-sm font-medium text-gray-700">Duración (años)</label>
                                <input type="number" id="future-savings-years" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="5" min="1">
                            </div>
                        </div>
                        <p class="text-sm text-center text-gray-600">Aportación mensual a RV: <strong id="monthly-dca-display"></strong></p>
                    </div>
                </div>
                
                 <!-- Ingresos Extraordinarios -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Ingresos Extraordinarios</h3>
                    <div id="extra-income-container" class="space-y-4"></div>
                    <button id="add-extra-income-btn" class="mt-3 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i> Añadir Ingreso Extra
                    </button>
                </div>

                <!-- DCA Oportunista -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">DCA Oportunista 
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">Ajusta tu aportación a RV basado en la caída/subida del S&P 500.</span>
                        </div>
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label for="dca-drop" class="block text-sm font-medium text-gray-700">Invertir 2x si S&P 500 cae un (%)</label>
                            <input type="number" id="dca-drop" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="20">
                        </div>
                        <div>
                            <label for="dca-rise" class="block text-sm font-medium text-gray-700">Invertir 0.5x si S&P 500 sube un (%)</label>
                            <input type="number" id="dca-rise" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="15">
                        </div>
                         <p class="text-sm text-center text-gray-600">El dinero no invertido en subidas se guarda para las caídas.</p>
                    </div>
                </div>

                <!-- Rebalanceo Automático -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Rebalanceo Automático (RV/RF)</h3>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="rebalance-enabled" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="rebalance-enabled" class="ml-2 block text-sm font-medium text-gray-900">Activar Rebalanceo Anual</label>
                    </div>
                    <div id="rebalance-options" class="collapsible-options space-y-3">
                        <div>
                            <label for="rebalance-target" class="block text-sm font-medium text-gray-700">Objetivo RV (%)</label>
                            <input type="number" id="rebalance-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="60">
                        </div>
                        <div>
                            <label for="rebalance-band" class="block text-sm font-medium text-gray-700">Banda de Tolerancia (+/- %)</label>
                            <input type="number" id="rebalance-band" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="5">
                        </div>
                    </div>
                </div>
                
                <!-- Inversión Automática de Liquidez -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Inversión Automática de Liquidez</h3>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="liquidity-sweep-enabled" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="liquidity-sweep-enabled" class="ml-2 block text-sm font-medium text-gray-900">Activar Inversión del Exceso</label>
                    </div>
                    <div id="liquidity-sweep-options" class="collapsible-options space-y-3">
                        <div>
                            <label for="liquidity-floor" class="block text-sm font-medium text-gray-700">Suelo de Liquidez (€)</label>
                            <input type="number" id="liquidity-floor" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="10000">
                        </div>
                    </div>
                </div>


                <!-- Rentabilidades -->
                <div class="mb-6">
                     <h3 class="text-lg font-semibold mb-3 text-gray-800">Rentabilidades Anuales Promedio</h3>
                     <div class="space-y-3">
                         <div>
                            <label for="rf-return" class="block text-sm font-medium text-gray-700">Renta Fija (%)</label>
                            <input type="number" id="rf-return" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="2.5">
                        </div>
                        <div>
                            <label for="cash-return" class="block text-sm font-medium text-gray-700">Cuenta Ahorro (%)</label>
                            <input type="number" id="cash-return" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="0.70">
                        </div>
                         <p class="text-sm text-gray-500">Nota: La rentabilidad de la RV se basa en el escenario del S&P 500 seleccionado.</p>
                     </div>
                </div>
            </div>

            <!-- Columna de Resultados y Gráfico -->
            <div class="lg:w-2/3 bg-white p-6 rounded-2xl shadow-lg">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Escenario del Mercado (S&P 500)</h2>
                    <p class="text-sm text-gray-600 mb-4">Selecciona un escenario predefinido o introduce tus propias rentabilidades anuales para los próximos 30 años.</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="scenario-pessimistic" class="flex-1 bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600 transition">Pesimista</button>
                        <button id="scenario-neutral" class="flex-1 bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 transition">Neutral</button>
                        <button id="scenario-optimistic" class="flex-1 bg-green-500 text-white py-2 px-3 rounded-lg hover:bg-green-600 transition">Optimista</button>
                    </div>
                    <div id="sp500-inputs" class="grid grid-cols-5 md:grid-cols-10 gap-2">
                        <!-- Inputs generados por JS -->
                    </div>
                </div>

                <div class="border-t pt-6">
                    <h2 class="text-2xl font-bold mb-4">Resultados de la Simulación</h2>
                    <canvas id="simulation-chart"></canvas>
                    <div id="results-summary" class="mt-6 text-center grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <!-- Resumen generado por JS -->
                    </div>
                </div>
                
                <div class="border-t pt-6 mt-8">
                    <h2 class="text-2xl font-bold mb-4">Registro de Movimientos Anuales</h2>
                    <div id="log-table-container" class="w-full">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Año</th>
                                    <th scope="col" class="px-4 py-3">Patrimonio Inicial</th>
                                    <th scope="col" class="px-4 py-3">Movimientos</th>
                                    <th scope="col" class="px-4 py-3">Crecimiento / Pérdida</th>
                                    <th scope="col" class="px-4 py-3">Patrimonio Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Referencias a elementos del DOM
    const elements = {
        initialRv: document.getElementById('initial-rv'),
        initialRf: document.getElementById('initial-rf'),
        initialCash: document.getElementById('initial-cash'),
        futureSavings: document.getElementById('future-savings'),
        futureSavingsYears: document.getElementById('future-savings-years'),
        monthlyDcaDisplay: document.getElementById('monthly-dca-display'),
        dcaDrop: document.getElementById('dca-drop'),
        dcaRise: document.getElementById('dca-rise'),
        rfReturn: document.getElementById('rf-return'),
        cashReturn: document.getElementById('cash-return'),
        rebalanceEnabled: document.getElementById('rebalance-enabled'),
        rebalanceOptions: document.getElementById('rebalance-options'),
        rebalanceTarget: document.getElementById('rebalance-target'),
        rebalanceBand: document.getElementById('rebalance-band'),
        liquiditySweepEnabled: document.getElementById('liquidity-sweep-enabled'),
        liquiditySweepOptions: document.getElementById('liquidity-sweep-options'),
        liquidityFloor: document.getElementById('liquidity-floor'),
        extraIncomeContainer: document.getElementById('extra-income-container'),
        addExtraIncomeBtn: document.getElementById('add-extra-income-btn'),
        sp500InputsContainer: document.getElementById('sp500-inputs'),
        chartCanvas: document.getElementById('simulation-chart'),
        resultsSummary: document.getElementById('results-summary'),
        logTableBody: document.querySelector('#log-table-container tbody'),
        importBtn: document.getElementById('import-btn'),
        exportBtn: document.getElementById('export-btn'),
        importFile: document.getElementById('import-file'),
        scenarioPessimistic: document.getElementById('scenario-pessimistic'),
        scenarioNeutral: document.getElementById('scenario-neutral'),
        scenarioOptimistic: document.getElementById('scenario-optimistic'),
    };

    let chartInstance = null;
    const YEARS = 30;

    // --- Lógica de la Simulación ---
    function runSimulation(config) {
        let rv = config.initialRv;
        let rf = config.initialRf;
        let cash = config.initialCash;
        let opportunityFund = 0;

        const history = [];
        
        for (let year = 1; year <= YEARS; year++) {
            const initialTotal = rv + rf + cash + opportunityFund;
            
            let yearlyDcaApplied = 0;
            let amountRebalanced = 0;
            let amountSwept = 0;

            // Recibir ingresos extraordinarios
             config.extraordinaryIncomes.forEach(income => {
                if (income.receptionYear === year) {
                    cash += income.amount;
                }
            });

            // 1. Aportaciones (DCA)
            let regularMonthlyDca = 0;
            if (year <= config.futureSavingsYears && config.futureSavingsYears > 0) {
                regularMonthlyDca = (config.futureSavings / config.futureSavingsYears) / 12;
            }

            let extraMonthlyDca = config.extraordinaryIncomes
                .filter(income => year >= income.receptionYear && year < income.receptionYear + income.dcaPeriod)
                .reduce((total, income) => total + (income.amount / (income.dcaPeriod * 12)), 0);

            let totalMonthlyDca = regularMonthlyDca + extraMonthlyDca;

            if (totalMonthlyDca > 0) {
                const sp500Return = config.sp500Scenario[year - 1] / 100;
                let dcaMultiplier = 1;
                
                if (sp500Return <= -(config.dcaDrop / 100)) dcaMultiplier = 2;
                else if (sp500Return >= (config.dcaRise / 100)) dcaMultiplier = 0.5;

                let yearlyDca = totalMonthlyDca * 12 * dcaMultiplier;
                let dcaFromCash = Math.min(cash, yearlyDca);
                
                if (dcaMultiplier === 2 && dcaFromCash < yearlyDca) {
                   const needed = yearlyDca - dcaFromCash;
                   const fromOpportunityFund = Math.min(opportunityFund, needed);
                   dcaFromCash += fromOpportunityFund;
                   opportunityFund -= fromOpportunityFund;
                }
                
                cash -= dcaFromCash;
                rv += dcaFromCash;
                yearlyDcaApplied = dcaFromCash;

                if (dcaMultiplier === 0.5) {
                    opportunityFund += (totalMonthlyDca * 12 * 0.5);
                }
            }

            // 2. Crecimiento de las inversiones
            const currentYearSp500Return = config.sp500Scenario[year - 1] / 100;
            rv *= (1 + currentYearSp500Return); 
            rf *= (1 + config.rfReturn / 100);
            cash *= (1 + config.cashReturn / 100);
            opportunityFund *= (1 + config.cashReturn / 100);

            // 3. Rebalanceo (si está activado)
            if (config.rebalanceEnabled) {
                const investedTotal = rv + rf;
                if (investedTotal > 0) {
                    const currentRvRatio = rv / investedTotal;
                    const targetRatio = config.rebalanceTarget / 100;
                    const band = config.rebalanceBand / 100;
                    const upperBand = targetRatio + band;
                    const lowerBand = targetRatio - band;

                    if (currentRvRatio > upperBand || currentRvRatio < lowerBand) {
                        const amountToMove = (rv - investedTotal * targetRatio);
                        rv -= amountToMove;
                        rf += amountToMove;
                        amountRebalanced = amountToMove;
                    }
                }
            }
            
            // 4. Inversión Automática de Liquidez (Sweep)
            let currentLiquidity = cash + opportunityFund;
            if (config.liquiditySweepEnabled && currentLiquidity > config.liquidityFloor) {
                const excessCash = currentLiquidity - config.liquidityFloor;
                
                const fromOpportunityFund = Math.min(opportunityFund, excessCash);
                opportunityFund -= fromOpportunityFund;
                
                const fromCash = excessCash - fromOpportunityFund;
                cash -= fromCash;

                rf += excessCash;
                amountSwept = excessCash;
            }

            const finalTotal = rv + rf + cash + opportunityFund;
            const growth = finalTotal - initialTotal - yearlyDcaApplied;


            history.push({
                year: year,
                initialTotal: initialTotal,
                total: finalTotal,
                rv: rv,
                rf: rf,
                liquidity: cash + opportunityFund,
                dcaContribution: yearlyDcaApplied,
                rebalancedAmount: amountRebalanced,
                sweptAmount: amountSwept,
                growth: growth
            });
        }

        const totalExtraIncomes = config.extraordinaryIncomes.reduce((sum, income) => sum + income.amount, 0);
        const totalInvested = config.initialRv + config.initialRf + config.initialCash + config.futureSavings + totalExtraIncomes;

        return { history, totalInvested };
    }

    // --- Lógica de la Interfaz (UI) ---

    function updateUI(config) {
        elements.initialRv.value = config.initialRv;
        elements.initialRf.value = config.initialRf;
        elements.initialCash.value = config.initialCash;
        elements.futureSavings.value = config.futureSavings;
        elements.futureSavingsYears.value = config.futureSavingsYears;
        elements.dcaDrop.value = config.dcaDrop;
        elements.dcaRise.value = config.dcaRise;
        elements.rfReturn.value = config.rfReturn;
        elements.cashReturn.value = config.cashReturn;
        elements.rebalanceEnabled.checked = config.rebalanceEnabled;
        elements.rebalanceTarget.value = config.rebalanceTarget;
        elements.rebalanceBand.value = config.rebalanceBand;
        elements.liquiditySweepEnabled.checked = config.liquiditySweepEnabled;
        elements.liquidityFloor.value = config.liquidityFloor;
        
        elements.rebalanceOptions.classList.toggle('active', config.rebalanceEnabled);
        elements.liquiditySweepOptions.classList.toggle('active', config.liquiditySweepEnabled);
        
        updateMonthlyDcaDisplay(config);

        elements.extraIncomeContainer.innerHTML = '';
        if(config.extraordinaryIncomes) {
            config.extraordinaryIncomes.forEach(income => addExtraordinaryIncomeRow(income));
        }

        elements.sp500InputsContainer.innerHTML = '';
        config.sp500Scenario.forEach((value, index) => {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'w-full p-1 border border-gray-300 rounded-md text-center';
            input.value = value;
            input.dataset.year = index;
            elements.sp500InputsContainer.appendChild(input);
        });
    }
    
    function addExtraordinaryIncomeRow(income = { amount: 10000, receptionYear: 10, dcaPeriod: 1 }) {
        const rowId = `income-${Date.now()}`;
        const row = document.createElement('div');
        row.id = rowId;
        row.className = 'p-3 border rounded-lg bg-white space-y-2';
        row.innerHTML = `
            <div class="flex justify-between items-center">
                <p class="text-sm font-semibold">Ingreso Extra</p>
                <button data-row-id="${rowId}" class="text-red-500 hover:text-red-700 delete-income-btn">&times;</button>
            </div>
            <div>
                <label class="text-xs">Cantidad (€)</label>
                <input type="number" class="w-full p-1 border rounded" data-field="amount" value="${income.amount}">
            </div>
            <div class="flex gap-2">
                <div class="w-1/2">
                    <label class="text-xs">Año Recepción</label>
                    <input type="number" class="w-full p-1 border rounded" data-field="receptionYear" value="${income.receptionYear}" min="1" max="30">
                </div>
                <div class="w-1/2">
                    <label class="text-xs">Invertir en</label>
                    <select class="w-full p-1 border rounded" data-field="dcaPeriod">
                        <option value="1" ${income.dcaPeriod == 1 ? 'selected' : ''}>1 año</option>
                        <option value="1.5" ${income.dcaPeriod == 1.5 ? 'selected' : ''}>1.5 años</option>
                        <option value="2" ${income.dcaPeriod == 2 ? 'selected' : ''}>2 años</option>
                    </select>
                </div>
            </div>
        `;
        elements.extraIncomeContainer.appendChild(row);
    }


    function renderChart(history, totalInvested) {
        if (chartInstance) {
            chartInstance.destroy();
        }
        const finalPortfolio = history.length > 0 ? history[history.length - 1] : {total:0, rv:0, rf:0, liquidity:0};
        
        const ctx = elements.chartCanvas.getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(h => `Año ${h.year}`),
                datasets: [
                {
                    label: 'Patrimonio Total',
                    data: history.map(h => h.total),
                    borderColor: 'rgba(79, 70, 229, 1)',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.1,
                    borderWidth: 3
                },
                {
                    label: 'Renta Variable (RV)',
                    data: history.map(h => h.rv),
                    borderColor: 'rgba(5, 150, 105, 1)',
                    fill: false,
                    tension: 0.1,
                    borderWidth: 1.5,
                },
                {
                    label: 'Renta Fija (RF)',
                    data: history.map(h => h.rf),
                    borderColor: 'rgba(217, 119, 6, 1)',
                    fill: false,
                    tension: 0.1,
                    borderWidth: 1.5,
                },
                 {
                    label: 'Liquidez',
                    data: history.map(h => h.liquidity),
                    borderColor: 'rgba(107, 114, 128, 1)',
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    borderWidth: 1.5,
                }
            ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (tooltipItems) => tooltipItems[0].label,
                            label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`,
                            footer: (tooltipItems) => {
                                const dataIndex = tooltipItems[0].dataIndex;
                                const yearData = history[dataIndex];
                                const lines = [];
                                
                                lines.push(`Crecimiento Año: ${formatCurrency(yearData.growth)}`);

                                if (yearData.dcaContribution > 0) {
                                    lines.push(`Aportación DCA: ${formatCurrency(yearData.dcaContribution)}`);
                                }

                                if (Math.abs(yearData.rebalancedAmount) > 0.01) {
                                    const direction = yearData.rebalancedAmount > 0 ? 'hacia RF' : 'hacia RV';
                                    const rebalanceText = `Rebalanceo: ${formatCurrency(Math.abs(yearData.rebalancedAmount))} ${direction}`;
                                    lines.push(rebalanceText);
                                }
                                
                                if (yearData.sweptAmount > 0) {
                                    lines.push(`Inversión Liquidez: ${formatCurrency(yearData.sweptAmount)} hacia RF`);
                                }
                                
                                return lines;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: (value) => formatCurrency(value)
                        }
                    }
                }
            }
        });

        const returnPercentage = totalInvested > 0 ? ((finalPortfolio.total - totalInvested) / totalInvested) * 100 : 0;
        
        elements.resultsSummary.innerHTML = `
            <div class="tooltip bg-indigo-50 p-4 rounded-lg">
                <p class="text-sm text-indigo-800 font-semibold">Patrimonio Total</p>
                <p class="text-2xl font-bold text-indigo-900">${formatCurrency(finalPortfolio.total)}</p>
                <span class="tooltiptext">Retorno Total: ${returnPercentage.toFixed(2)}%</span>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm text-gray-800 font-semibold">Total Aportado</p>
                <p class="text-2xl font-bold text-gray-900">${formatCurrency(totalInvested)}</p>
            </div>
            <div class="bg-emerald-50 p-4 rounded-lg">
                <p class="text-sm text-emerald-800 font-semibold">Valor Final RV</p>
                <p class="text-2xl font-bold text-emerald-900">${formatCurrency(finalPortfolio.rv)}</p>
            </div>
            <div class="bg-amber-50 p-4 rounded-lg">
                <p class="text-sm text-amber-800 font-semibold">Valor Final RF</p>
                <p class="text-2xl font-bold text-amber-900">${formatCurrency(finalPortfolio.rf)}</p>
            </div>
             <div class="bg-gray-200 p-4 rounded-lg">
                <p class="text-sm text-gray-800 font-semibold">Valor Final Liquidez</p>
                <p class="text-2xl font-bold text-gray-900">${formatCurrency(finalPortfolio.liquidity)}</p>
            </div>
        `;
    }
    
    function renderLogTable(history) {
        elements.logTableBody.innerHTML = '';
        history.forEach(log => {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50';

            let movementsHtml = '';
            if (log.dcaContribution > 0) {
                movementsHtml += `<div class="text-xs"><strong>DCA:</strong> ${formatCurrency(log.dcaContribution)} (Liq. &rarr; RV)</div>`;
            }
            if (Math.abs(log.rebalancedAmount) > 0.01) {
                const direction = log.rebalancedAmount > 0 ? '(RV &rarr; RF)' : '(RF &rarr; RV)';
                movementsHtml += `<div class="text-xs"><strong>Rebalanceo:</strong> ${formatCurrency(Math.abs(log.rebalancedAmount))} ${direction}</div>`;
            }
            if (log.sweptAmount > 0) {
                movementsHtml += `<div class="text-xs"><strong>Inv. Liq.:</strong> ${formatCurrency(log.sweptAmount)} (Liq. &rarr; RF)</div>`;
            }

            const growthClass = log.growth >= 0 ? 'text-green-600' : 'text-red-600';

            row.innerHTML = `
                <td class="px-4 py-2 font-medium text-gray-900">${log.year}</td>
                <td class="px-4 py-2">${formatCurrency(log.initialTotal)}</td>
                <td class="px-4 py-2">${movementsHtml || '---'}</td>
                <td class="px-4 py-2 font-semibold ${growthClass}">${formatCurrency(log.growth)}</td>
                <td class="px-4 py-2 font-bold text-gray-900">${formatCurrency(log.total)}</td>
            `;
            elements.logTableBody.appendChild(row);
        });
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);
    }
    
    function getConfigFromUI() {
        const sp500Scenario = Array.from(elements.sp500InputsContainer.querySelectorAll('input')).map(input => parseFloat(input.value) || 0);
        
        const extraordinaryIncomes = Array.from(elements.extraIncomeContainer.children).map(row => ({
            amount: parseFloat(row.querySelector('[data-field="amount"]').value) || 0,
            receptionYear: parseInt(row.querySelector('[data-field="receptionYear"]').value) || 1,
            dcaPeriod: parseFloat(row.querySelector('[data-field="dcaPeriod"]').value) || 1,
        }));

        return {
            initialRv: parseFloat(elements.initialRv.value) || 0,
            initialRf: parseFloat(elements.initialRf.value) || 0,
            initialCash: parseFloat(elements.initialCash.value) || 0,
            futureSavings: parseFloat(elements.futureSavings.value) || 0,
            futureSavingsYears: parseInt(elements.futureSavingsYears.value) || 1,
            dcaDrop: parseFloat(elements.dcaDrop.value) || 0,
            dcaRise: parseFloat(elements.dcaRise.value) || 0,
            rfReturn: parseFloat(elements.rfReturn.value) || 0,
            cashReturn: parseFloat(elements.cashReturn.value) || 0,
            rebalanceEnabled: elements.rebalanceEnabled.checked,
            rebalanceTarget: parseFloat(elements.rebalanceTarget.value) || 0,
            rebalanceBand: parseFloat(elements.rebalanceBand.value) || 0,
            liquiditySweepEnabled: elements.liquiditySweepEnabled.checked,
            liquidityFloor: parseFloat(elements.liquidityFloor.value) || 0,
            extraordinaryIncomes: extraordinaryIncomes,
            sp500Scenario: sp500Scenario
        };
    }
    
    function saveConfigToLocalStorage(config) {
        localStorage.setItem('financialSimulatorConfig', JSON.stringify(config));
    }
    
    function loadConfigFromLocalStorage() {
        const savedConfig = localStorage.getItem('financialSimulatorConfig');
        return savedConfig ? JSON.parse(savedConfig) : getDefaultConfig();
    }
    
    function getDefaultConfig() {
        return {
            initialRv: 53000, initialRf: 31000, initialCash: 91000,
            futureSavings: 20000, futureSavingsYears: 5,
            dcaDrop: 20, dcaRise: 15,
            rfReturn: 2.5, cashReturn: 0.70,
            rebalanceEnabled: false, rebalanceTarget: 60, rebalanceBand: 5,
            liquiditySweepEnabled: false, liquidityFloor: 10000,
            extraordinaryIncomes: [],
            sp500Scenario: generateScenario('neutral')
        };
    }

    function generateScenario(type) {
        const scenario = [];
        for (let i = 0; i < YEARS; i++) {
            let value;
            switch (type) {
                case 'pessimistic': // Avg ~3-4%, with significant volatility and a big crash
                    value = (Math.random() - 0.5) * 40 + 3; 
                    if (i === 1 || i === 2) value = (Math.random() * -20) -10; // Crash years
                    if (i > 2 && i < 6) value = Math.random() * 15; // Slow recovery
                    break;
                case 'optimistic':  // Avg ~12-14%, strong bull run
                    value = (Math.random() - 0.4) * 25 + 12; 
                     if (i % 7 === 0 && i > 0) value = (Math.random() * -5) -2; // Minor correction
                    break;
                default: 'neutral' // Avg ~8-10%, historical average with volatility
                    value = (Math.random() - 0.45) * 35 + 9;
                    if (i === 2) value = -18; // A correction year
                    break;
            }
            scenario.push(parseFloat(value.toFixed(2)));
        }
        return scenario;
    }
    
    function updateMonthlyDcaDisplay(config) {
        const years = config.futureSavingsYears > 0 ? config.futureSavingsYears : 1;
        const monthlyDca = (config.futureSavings / years) / 12;
        elements.monthlyDcaDisplay.textContent = `${monthlyDca.toFixed(2)} €`;
    }

    function liveUpdate() {
        const config = getConfigFromUI();
        updateMonthlyDcaDisplay(config);
        saveConfigToLocalStorage(config);
        const simResults = runSimulation(config);
        renderChart(simResults.history, simResults.totalInvested);
        renderLogTable(simResults.history);
    }

    const inputsToWatch = [
        elements.initialRv, elements.initialRf, elements.initialCash,
        elements.futureSavings, elements.futureSavingsYears,
        elements.dcaDrop, elements.dcaRise, elements.rfReturn, elements.cashReturn,
        elements.rebalanceEnabled, elements.rebalanceTarget, elements.rebalanceBand,
        elements.liquiditySweepEnabled, elements.liquidityFloor
    ];
    inputsToWatch.forEach(input => input.addEventListener('input', liveUpdate));
    
    elements.sp500InputsContainer.addEventListener('input', (event) => {
        if (event.target.tagName === 'INPUT') liveUpdate();
    });
    
    elements.extraIncomeContainer.addEventListener('input', (event) => {
         if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') liveUpdate();
    });
    
    elements.addExtraIncomeBtn.addEventListener('click', () => {
        addExtraordinaryIncomeRow();
        liveUpdate();
    });
    
    elements.extraIncomeContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-income-btn')) {
            const rowId = event.target.dataset.rowId;
            document.getElementById(rowId).remove();
            liveUpdate();
        }
    });

    elements.exportBtn.addEventListener('click', () => {
        const config = getConfigFromUI();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "simulacion_config.json";
        a.click();
    });

    elements.importBtn.addEventListener('click', () => elements.importFile.click());
    elements.importFile.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedConfig = JSON.parse(e.target.result);
                // Basic validation
                if (importedConfig.sp500Scenario && importedConfig.sp500Scenario.length === YEARS) {
                    const fullConfig = {...getDefaultConfig(), ...importedConfig};
                    updateUI(fullConfig);
                    liveUpdate();
                    alert('Configuración importada con éxito!');
                } else {
                    alert('Error: El archivo de configuración no es válido.');
                }
            } catch (error) {
                console.error("Error al importar el archivo:", error);
                alert('Error al leer el archivo. Asegúrate de que es un JSON válido.');
            }
        };
        reader.readAsText(file);
        elements.importFile.value = '';
    });
    
    [elements.scenarioPessimistic, elements.scenarioNeutral, elements.scenarioOptimistic].forEach(btn => {
        btn.addEventListener('click', () => {
            const scenarioType = btn.id.split('-')[1];
            const config = getConfigFromUI();
            config.sp500Scenario = generateScenario(scenarioType);
            updateUI(config);
            liveUpdate();
        });
    });
    
    function setupCollapsible(checkbox, optionsDiv) {
        checkbox.addEventListener('change', () => {
            optionsDiv.classList.toggle('active', checkbox.checked);
        });
    }

    setupCollapsible(elements.rebalanceEnabled, elements.rebalanceOptions);
    setupCollapsible(elements.liquiditySweepEnabled, elements.liquiditySweepOptions);
    
    function init() {
        const config = loadConfigFromLocalStorage();
        updateUI(config);
        liveUpdate();
    }
    
    init();
});
</script>

</body>
</html>

