<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Futuros Financieros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Panel de Futuros Financieros</h1>
            <p class="mt-2 text-lg text-gray-600">Análisis comparativo de 4 escenarios laborales vs. 3 escenarios de mercado a 30 años.</p>
        </header>

        <!-- Controles de Capital Inicial -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-2xl mx-auto">
            <h2 class="text-xl font-bold text-center mb-4">Configura tu Simulación</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
                <div class="sm:col-span-1">
                    <label for="globalInitialCapitalRV" class="block text-sm font-medium text-gray-700">Capital Inicial RV (€)</label>
                    <input type="number" id="globalInitialCapitalRV" value="10000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="sm:col-span-1">
                    <label for="globalInitialCapitalRF" class="block text-sm font-medium text-gray-700">Capital Inicial RF (€)</label>
                    <input type="number" id="globalInitialCapitalRF" value="6000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="sm:col-span-1 sm:mt-5">
                    <button id="recalculateButton" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        Actualizar Gráficos
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de los gráficos -->
        <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            <!-- Los gráficos se insertarán aquí dinámicamente -->
        </div>
    </div>

    <script>
    // --- INICIO DE DATOS EMBEBIDOS (PLANES BASE) ---
    const simulationData = {
        "no_work": {
            "negativo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }], "crises": [{ "id": 1756824547145, "date": "2028-05", "percent": 35 }, { "id": 1756824575391, "date": "2040-08", "percent": 25 }], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834425045, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "promedio": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 7.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }], "crises": [{ "id": 1756831466444, "date": "2038-05", "percent": 35 }], "transfers": [{ "id": 1756837072616, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756837075234, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837077444, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837106873, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "positivo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 8.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }], "crises": [], "transfers": [{ "id": 1756831567313, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756831575514, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756831599948, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756831838070, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] }
        },
        "work_normal": {
            "negativo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756834514695, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756834536928, "date": "2026-01", "amount": 250, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756824547145, "date": "2028-05", "percent": 35 }, { "id": 1756824575391, "date": "2040-08", "percent": 25 }], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834425045, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836763591, "date": "2045-10", "amount": 10000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "promedio": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 7.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756837150060, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756837159695, "date": "2026-01", "amount": 250, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756831466444, "date": "2038-05", "percent": 35 }], "transfers": [{ "id": 1756837072616, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756837075234, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837077444, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837106873, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837190968, "date": "2045-10", "amount": 10000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "positivo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 8.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756836380842, "date": "2026-01", "amount": 250, "period": "quarterly", "times": 40, "target": "rf" }, { "id": 1756836388914, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rv" }], "crises": [], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756835532703, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836425808, "date": "2045-10", "amount": 10000, "period": "once", "times": 1, "direction": "rf-rv" }] }
        },
        "work_bien": {
            "negativo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756836826733, "date": "2026-01", "amount": 1500, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756836830725, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756824547145, "date": "2028-05", "percent": 35 }, { "id": 1756824575391, "date": "2040-08", "percent": 25 }], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834425045, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836840167, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836860976, "date": "2050-10", "amount": 10000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "promedio": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 7.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756837220215, "date": "2026-01", "amount": 1500, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756837224012, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756831466444, "date": "2038-05", "percent": 35 }], "transfers": [{ "id": 1756837072616, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756837075234, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837077444, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837106873, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837233534, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "positivo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 8.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756836485409, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 40, "target": "rf" }, { "id": 1756836489361, "date": "2026-01", "amount": 1500, "period": "quarterly", "times": 40, "target": "rv" }], "crises": [], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756835532703, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836494978, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] }
        },
        "work_muy_bien": {
            "negativo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756836918867, "date": "2026-01", "amount": 2250, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756836923998, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756824547145, "date": "2028-05", "percent": 35 }, { "id": 1756824575391, "date": "2040-08", "percent": 25 }], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834425045, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836840167, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836931375, "date": "2050-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "promedio": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 7.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756837274342, "date": "2026-01", "amount": 2250, "period": "quarterly", "times": 40, "target": "rv" }, { "id": 1756837278036, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rf" }], "crises": [{ "id": 1756831466444, "date": "2038-05", "percent": 35 }], "transfers": [{ "id": 1756837072616, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756837075234, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837077444, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837106873, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837233534, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756837307507, "date": "2050-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] },
            "positivo": { "initialCapitalRV": 100000, "initialCapitalRF": 60000, "years": 30, "rvReturn": 8.5, "rfReturn": 2.5, "contributions": [{ "id": 1756828373070, "date": "2026-01", "amount": 2000, "period": "quarterly", "times": 12, "target": "rv" }, { "id": 1756829821948, "date": "2026-01", "amount": 500, "period": "quarterly", "times": 12, "target": "rf" }, { "id": 1756836076821, "date": "2026-01", "amount": 750, "period": "quarterly", "times": 40, "target": "rf" }, { "id": 1756836080834, "date": "2026-01", "amount": 2250, "period": "quarterly", "times": 40, "target": "rv" }], "crises": [], "transfers": [{ "id": 1756833986165, "date": "2026-01", "amount": 1000, "period": "quarterly", "times": 20, "direction": "rf-rv" }, { "id": 1756834421081, "date": "2030-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756834423389, "date": "2035-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756835532703, "date": "2040-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756835971357, "date": "2045-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }, { "id": 1756836090001, "date": "2050-10", "amount": 20000, "period": "once", "times": 1, "direction": "rf-rv" }] }
        }
    };
    // --- FIN DE DATOS EMBEBIDOS ---

    let chartInstances = {};

    function saveCapitalToStorage(rv, rf) {
        try {
            localStorage.setItem('financialDashboardCapital', JSON.stringify({ rv, rf }));
        } catch (e) {
            console.error("Error saving to localStorage", e);
        }
    }

    function loadCapitalFromStorage() {
        try {
            const saved = localStorage.getItem('financialDashboardCapital');
            if (saved) {
                const { rv, rf } = JSON.parse(saved);
                document.getElementById('globalInitialCapitalRV').value = rv;
                document.getElementById('globalInitialCapitalRF').value = rf;
            }
        } catch (e) {
            console.error("Error loading from localStorage", e);
        }
    }

    // --- NUEVO MOTOR DE SIMULACIÓN AVANZADO ---
    function calculateSimulation(state) {
        const months = state.years * 12;
        const monthlyRvReturn = Math.pow(1 + state.rvReturn / 100, 1/12) - 1;
        const monthlyRfReturn = Math.pow(1 + state.rfReturn / 100, 1/12) - 1;
        
        let rvValues = [state.initialCapitalRV];
        let rfValues = [state.initialCapitalRF];
        
        const SIMULATION_START_DATE = new Date(2025, 0, 1); 

        for (let month = 1; month <= months; month++) {
            const currentDate = new Date(SIMULATION_START_DATE.getFullYear(), SIMULATION_START_DATE.getMonth() + month, 1);
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            let rvValue = rvValues[month - 1] * (1 + monthlyRvReturn);
            let rfValue = rfValues[month - 1] * (1 + monthlyRfReturn);

            const processPeriodicEvent = (event, action) => {
                const [year, monthEvent] = event.date.split('-').map(Number);
                const eventDate = new Date(year, monthEvent - 1, 1);
                const monthsDiff = (currentDate.getFullYear() - eventDate.getFullYear()) * 12 + (currentDate.getMonth() - eventDate.getMonth());
                
                let shouldTrigger = false;
                const period = event.period;
                if (period === 'once' && monthsDiff === 0) shouldTrigger = true;
                else if (period === 'monthly' && monthsDiff >= 0 && monthsDiff < event.times) shouldTrigger = true;
                else if (period === 'quarterly' && monthsDiff >= 0 && monthsDiff % 3 === 0 && monthsDiff / 3 < event.times) shouldTrigger = true;
                else if (period === 'yearly' && monthsDiff >= 0 && monthsDiff % 12 === 0 && monthsDiff / 12 < event.times) shouldTrigger = true;
                
                if (shouldTrigger) action(event);
            };

            (state.contributions || []).forEach(c => processPeriodicEvent(c, e => {
                if (e.target === 'rv') { rvValue += e.amount; }
                else { rfValue += e.amount; }
            }));
            (state.crises || []).forEach(c => { if (c.date === dateStr) rvValue *= (1 - c.percent / 100); });
            (state.transfers || []).forEach(t => processPeriodicEvent(t, e => {
                if (e.direction === 'rv-rf') { const amount = Math.min(e.amount, rvValue); rvValue -= amount; rfValue += amount; } 
                else { const amount = Math.min(e.amount, rfValue); rfValue -= amount; rvValue += amount; }
            }));
            
            // Lógica de Consolidación Dinámica Avanzada
            const currentYearInSim = Math.floor((month - 1) / 12);
            if (currentYearInSim >= 20 && (month % 12 === 0)) {
                const yearStartIndex = currentYearInSim * 12;
                const rvValueAtYearStart = rvValues[yearStartIndex];
                const rfValueAtYearStart = rfValues[yearStartIndex];

                if (rvValue > rvValueAtYearStart) {
                    const rfInterestGenerated = rfValueAtYearStart * (state.rfReturn / 100);
                    
                    if (rfInterestGenerated < 15000) {
                        const topUpNeeded = 15000 - rfInterestGenerated;
                        const maxTransferPercent = Math.min(state.rvReturn / 2, 2.5);
                        const maxTransferFromRv = rvValue * (maxTransferPercent / 100);
                        const transferAmount = Math.min(topUpNeeded, maxTransferFromRv, 15000);
                        
                        if (transferAmount > 0) {
                            rvValue -= transferAmount;
                            rfValue += transferAmount;
                        }
                    }
                }
            }

            rvValues.push(rvValue);
            rfValues.push(rfValue);
        }

        const labels = ['Inicio'];
        const annualTotals = [state.initialCapitalRV + state.initialCapitalRF];

        for (let year = 1; year <= state.years; year++) {
            labels.push(`Año ${year}`);
            const monthIndex = year * 12;
            if (monthIndex < rvValues.length) {
                const totalValue = rvValues[monthIndex] + rfValues[monthIndex];
                annualTotals.push(totalValue);
            }
        }
        
        return { labels, values: annualTotals };
    }


    function renderChart(canvasId, title, labels, datasets) {
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: { display: true, text: title, font: { size: 18, weight: '600' }, padding: { top: 10, bottom: 20 } },
                    tooltip: { mode: 'index', intersect: false, callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(context.parsed.y)}` } },
                    legend: { position: 'bottom' }
                },
                scales: { y: { beginAtZero: true, ticks: { callback: value => { if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M €`; if (value >= 1000) return `${(value / 1000)}k €`; return `${value} €`; } } } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }

    function runAllSimulations() {
        const chartsContainer = document.getElementById('charts-container');
        chartsContainer.innerHTML = '';
        
        const newCapitalRV = parseFloat(document.getElementById('globalInitialCapitalRV').value) || 0;
        const newCapitalRF = parseFloat(document.getElementById('globalInitialCapitalRF').value) || 0;

        saveCapitalToStorage(newCapitalRV, newCapitalRF);

        const workScenarios = [
            { id: 'no_work', title: 'Escenario: Sin Aportaciones Extra' },
            { id: 'work_normal', title: 'Escenario: Aportaciones Normales' },
            { id: 'work_bien', title: 'Escenario: Aportaciones Mejoradas' },
            { id: 'work_muy_bien', title: 'Escenario: Aportaciones Excelentes' }
        ];
        const marketScenarioStyles = {
            negativo: { label: 'Pesimista (Mercado Malo)', borderColor: '#ef4444', backgroundColor: '#ef4444' },
            promedio: { label: 'Promedio (Mercado Normal)', borderColor: '#3b82f6', backgroundColor: '#3b82f6' },
            positivo: { label: 'Positivo (Mercado Bueno)', borderColor: '#22c55e', backgroundColor: '#22c55e' }
        };

        workScenarios.forEach(workScenario => {
            const canvasId = `chart_${workScenario.id}`;
            const chartCardHTML = `<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6"><canvas id="${canvasId}"></canvas></div>`;
            chartsContainer.insertAdjacentHTML('beforeend', chartCardHTML);
            
            const datasets = [];
            let chartLabels = [];
            Object.keys(marketScenarioStyles).forEach(marketScenarioKey => {
                const state = JSON.parse(JSON.stringify(simulationData[workScenario.id][marketScenarioKey]));
                
                state.initialCapitalRV = newCapitalRV;
                state.initialCapitalRF = newCapitalRF;

                const result = calculateSimulation(state);
                if (result.labels.length > chartLabels.length) chartLabels = result.labels;
                datasets.push({
                    label: marketScenarioStyles[marketScenarioKey].label,
                    data: result.values,
                    borderColor: marketScenarioStyles[marketScenarioKey].borderColor,
                    backgroundColor: marketScenarioStyles[marketScenarioKey].backgroundColor + '1a',
                    borderWidth: 2.5,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0,
                    pointHitRadius: 10
                });
            });
            renderChart(canvasId, workScenario.title, chartLabels, datasets);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCapitalFromStorage();
        runAllSimulations(); 
        
        document.getElementById('recalculateButton').addEventListener('click', runAllSimulations);
    });

    </script>
</body>
</html>
