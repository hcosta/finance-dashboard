<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Futuros Financieros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Panel de Futuros Financieros</h1>
            <p class="mt-2 text-lg text-gray-600">Análisis comparativo de 4 escenarios laborales vs. 3 escenarios de mercado a 30 años (Plan Consolidado).</p>
        </header>

        <!-- Controles de Capital Inicial -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-2xl mx-auto">
            <h2 class="text-xl font-bold text-center mb-4">Configura tu Simulación</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
                <div class="sm:col-span-1">
                    <label for="globalInitialCapitalRV" class="block text-sm font-medium text-gray-700">Capital Inicial RV (€)</label>
                    <input type="number" id="globalInitialCapitalRV" value="10000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="sm:col-span-1">
                    <label for="globalInitialCapitalRF" class="block text-sm font-medium text-gray-700">Capital Inicial RF (€)</label>
                    <input type="number" id="globalInitialCapitalRF" value="6000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="sm:col-span-1 sm:mt-5">
                    <button id="recalculateButton" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        Actualizar Gráficos
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de los gráficos -->
        <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            <!-- Los gráficos se insertarán aquí dinámicamente -->
        </div>
    </div>

    <script>
    // --- INICIO DE DATOS EMBEBIDOS (CONSOLIDADOS V2) ---
    const simulationData = {
        "no_work": {
            "negativo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"}],"crises":[{"id":1756824547145,"date":"2028-05","percent":35},{"id":1756824575391,"date":"2040-08","percent":25}],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834425045,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "promedio": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":7.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"}],"crises":[{"id":1756831466444,"date":"2038-05","percent":35}],"transfers":[{"id":1756837072616,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756837075234,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837077444,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837106873,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "positivo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":8.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"}],"crises":[],"transfers":[{"id":1756831575514,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756831567313,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756831599948,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756831838070,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]}
        },
        "work_normal": {
            "negativo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756834514695,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rv"},{"id":1756834536928,"date":"2026-01","amount":250,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756824547145,"date":"2028-05","percent":35},{"id":1756824575391,"date":"2040-08","percent":25}],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834425045,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756836763591,"date":"2045-10","amount":10000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "promedio": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":7.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756837150060,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rv"},{"id":1756837159695,"date":"2026-01","amount":250,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756831466444,"date":"2038-05","percent":35}],"transfers":[{"id":1756837072616,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756837075234,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837077444,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837106873,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837190968,"date":"2045-10","amount":10000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "positivo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":8.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756836380842,"date":"2026-01","amount":250,"period":"quarterly","times":40,"target":"rf"},{"id":1756836388914,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rv"}],"crises":[],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756835532703,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756836425808,"date":"2045-10","amount":10000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]}
        },
        "work_bien": {
            "negativo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756836826733,"date":"2026-01","amount":1500,"period":"quarterly","times":40,"target":"rv"},{"id":1756836830725,"date":"2026-01","amount":500,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756824547145,"date":"2028-05","percent":35},{"id":1756824575391,"date":"2040-08","percent":25}],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834425045,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756836840167,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "promedio": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":7.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756837220215,"date":"2026-01","amount":1500,"period":"quarterly","times":40,"target":"rv"},{"id":1756837224012,"date":"2026-01","amount":500,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756831466444,"date":"2038-05","percent":35}],"transfers":[{"id":1756837072616,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756837075234,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837077444,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837106873,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837233534,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "positivo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":8.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756836485409,"date":"2026-01","amount":500,"period":"quarterly","times":40,"target":"rf"},{"id":1756836489361,"date":"2026-01","amount":1500,"period":"quarterly","times":40,"target":"rv"}],"crises":[],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756835532703,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756836494978,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]}
        },
        "work_muy_bien": {
            "negativo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756836918867,"date":"2026-01","amount":2250,"period":"quarterly","times":40,"target":"rv"},{"id":1756836923998,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756824547145,"date":"2028-05","percent":35},{"id":1756824575391,"date":"2040-08","percent":25}],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834425045,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756836840167,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "promedio": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":7.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756837274342,"date":"2026-01","amount":2250,"period":"quarterly","times":40,"target":"rv"},{"id":1756837278036,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rf"}],"crises":[{"id":1756831466444,"date":"2038-05","percent":35}],"transfers":[{"id":1756837072616,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756837075234,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837077444,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837106873,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756837233534,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]},
            "positivo": {"initialCapitalRV":100000,"initialCapitalRF":60000,"years":30,"rvReturn":8.5,"rfReturn":2.5,"contributions":[{"id":1756828373070,"date":"2026-01","amount":2000,"period":"quarterly","times":12,"target":"rv"},{"id":1756829821948,"date":"2026-01","amount":500,"period":"quarterly","times":12,"target":"rf"},{"id":1756836076821,"date":"2026-01","amount":750,"period":"quarterly","times":40,"target":"rf"},{"id":1756836080834,"date":"2026-01","amount":2250,"period":"quarterly","times":40,"target":"rv"}],"crises":[],"transfers":[{"id":1756833986165,"date":"2026-01","amount":1000,"period":"quarterly","times":20,"direction":"rf-rv"},{"id":1756834421081,"date":"2030-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756834423389,"date":"2035-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756835532703,"date":"2040-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1756835971357,"date":"2045-10","amount":20000,"period":"once","times":1,"direction":"rf-rv"},{"id":1856840000001,"date":"2047-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000002,"date":"2048-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000003,"date":"2049-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000004,"date":"2050-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000005,"date":"2051-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000006,"date":"2052-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000007,"date":"2053-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000008,"date":"2054-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"},{"id":1856840000009,"date":"2055-01","amount":15000,"period":"once","times":1,"direction":"rv-rf"}]}
        }
    };
    // --- FIN DE DATOS EMBEBIDOS ---

    let chartInstances = {};

    /**
     * Guarda los valores de capital en localStorage.
     * @param {number} rv - Capital de Renta Variable.
     * @param {number} rf - Capital de Renta Fija.
     */
    function saveCapitalToStorage(rv, rf) {
        try {
            const capitalToSave = { rv, rf };
            localStorage.setItem('financialDashboardCapital', JSON.stringify(capitalToSave));
        } catch (e) {
            console.error("Error saving capital to localStorage", e);
        }
    }

    /**
     * Carga los valores de capital desde localStorage y los pone en los inputs.
     */
    function loadCapitalFromStorage() {
        try {
            const savedCapital = localStorage.getItem('financialDashboardCapital');
            if (savedCapital) {
                const { rv, rf } = JSON.parse(savedCapital);
                document.getElementById('globalInitialCapitalRV').value = rv;
                document.getElementById('globalInitialCapitalRF').value = rf;
            }
        } catch (e) {
            console.error("Error loading capital from localStorage", e);
        }
    }

    function calculateSimulation(state) {
        const startDate = new Date();
        const months = state.years * 12;
        const monthlyRvReturn = Math.pow(1 + state.rvReturn / 100, 1 / 12) - 1;
        const monthlyRfReturn = Math.pow(1 + state.rfReturn / 100, 1 / 12) - 1;
        let rvValue = state.initialCapitalRV;
        let rfValue = state.initialCapitalRF;
        let annualTotals = [rvValue + rfValue];
        let labels = ['Inicio'];
        for (let month = 1; month <= months; month++) {
            const currentDate = new Date(startDate);
            currentDate.setMonth(startDate.getMonth() + month);
            const dateStr = currentDate.toISOString().slice(0, 7);
            rvValue *= (1 + monthlyRvReturn);
            rfValue *= (1 + monthlyRfReturn);
            (state.contributions || []).forEach(contrib => {
                const contribDate = new Date(contrib.date);
                const monthsDiff = (currentDate.getFullYear() - contribDate.getFullYear()) * 12 + (currentDate.getMonth() - contribDate.getMonth());
                let shouldAdd = false;
                if (contrib.period === 'monthly' && monthsDiff >= 0 && monthsDiff < contrib.times) shouldAdd = true;
                else if (contrib.period === 'quarterly' && monthsDiff >= 0 && monthsDiff % 3 === 0 && monthsDiff / 3 < contrib.times) shouldAdd = true;
                else if (contrib.period === 'yearly' && monthsDiff >= 0 && monthsDiff % 12 === 0 && monthsDiff / 12 < contrib.times) shouldAdd = true;
                if (shouldAdd) {
                    if (contrib.target === 'rv') rvValue += contrib.amount;
                    else rfValue += contrib.amount;
                }
            });
            (state.crises || []).forEach(crisis => {
                if (crisis.date === dateStr) rvValue *= (1 - crisis.percent / 100);
            });
            (state.transfers || []).forEach(transfer => {
                let shouldTransfer = false;
                if(transfer.period === 'once' && transfer.date === dateStr) {
                    shouldTransfer = true;
                } else {
                     const transferDate = new Date(transfer.date);
                     const monthsDiff = (currentDate.getFullYear() - transferDate.getFullYear()) * 12 + (currentDate.getMonth() - transferDate.getMonth());
                     if (transfer.period === 'monthly' && monthsDiff >= 0 && monthsDiff < transfer.times) shouldTransfer = true;
                     else if (transfer.period === 'quarterly' && monthsDiff >= 0 && monthsDiff % 3 === 0 && monthsDiff / 3 < transfer.times) shouldTransfer = true;
                     else if (transfer.period === 'yearly' && monthsDiff >= 0 && monthsDiff % 12 === 0 && monthsDiff / 12 < transfer.times) shouldTransfer = true;
                }

                if (shouldTransfer) {
                    if (transfer.direction === 'rv-rf') {
                        const amount = Math.min(transfer.amount, rvValue);
                        rvValue -= amount;
                        rfValue += amount;
                    } else { // rf-rv
                        const amount = Math.min(transfer.amount, rfValue);
                        rfValue -= amount;
                        rvValue += amount;
                    }
                }
            });
            if (month % 12 === 0) {
                annualTotals.push(rvValue + rfValue);
                labels.push(`Año ${month / 12}`);
            }
        }
        if (months % 12 !== 0) {
            annualTotals.push(rvValue + rfValue);
            labels.push(`Año ${state.years}`);
        }
        return { labels, values: annualTotals };
    }

    function renderChart(canvasId, title, labels, datasets) {
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: { display: true, text: title, font: { size: 18, weight: '600' }, padding: { top: 10, bottom: 20 } },
                    tooltip: { mode: 'index', intersect: false, callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(context.parsed.y)}` } },
                    legend: { position: 'bottom' }
                },
                scales: { y: { beginAtZero: true, ticks: { callback: value => { if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M €`; if (value >= 1000) return `${(value / 1000)}k €`; return `${value} €`; } } } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }

    function runAllSimulations() {
        const chartsContainer = document.getElementById('charts-container');
        chartsContainer.innerHTML = ''; // Limpia los canvas viejos para redibujar
        
        const newCapitalRV = parseFloat(document.getElementById('globalInitialCapitalRV').value) || 0;
        const newCapitalRF = parseFloat(document.getElementById('globalInitialCapitalRF').value) || 0;

        // Guarda los valores actuales en localStorage
        saveCapitalToStorage(newCapitalRV, newCapitalRF);

        const workScenarios = [
            { id: 'no_work', title: 'Escenario: Sin Aportaciones Extra' },
            { id: 'work_normal', title: 'Escenario: Aportaciones Normales' },
            { id: 'work_bien', title: 'Escenario: Aportaciones Mejoradas' },
            { id: 'work_muy_bien', title: 'Escenario: Aportaciones Excelentes' }
        ];
        const marketScenarioStyles = {
            negativo: { label: 'Pesimista (Mercado Malo)', borderColor: '#ef4444', backgroundColor: '#ef4444' },
            promedio: { label: 'Promedio (Mercado Normal)', borderColor: '#3b82f6', backgroundColor: '#3b82f6' },
            positivo: { label: 'Positivo (Mercado Bueno)', borderColor: '#22c55e', backgroundColor: '#22c55e' }
        };

        workScenarios.forEach(workScenario => {
            const canvasId = `chart_${workScenario.id}`;
            const chartCardHTML = `<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6"><canvas id="${canvasId}"></canvas></div>`;
            chartsContainer.insertAdjacentHTML('beforeend', chartCardHTML);
            
            const datasets = [];
            let chartLabels = [];
            Object.keys(marketScenarioStyles).forEach(marketScenarioKey => {
                // Copia profunda para no modificar el objeto original
                const state = JSON.parse(JSON.stringify(simulationData[workScenario.id][marketScenarioKey]));
                
                // Sobrescribe el capital inicial con los valores de los inputs
                state.initialCapitalRV = newCapitalRV;
                state.initialCapitalRF = newCapitalRF;

                const result = calculateSimulation(state);
                if (result.labels.length > chartLabels.length) chartLabels = result.labels;
                datasets.push({
                    label: marketScenarioStyles[marketScenarioKey].label,
                    data: result.values,
                    borderColor: marketScenarioStyles[marketScenarioKey].borderColor,
                    backgroundColor: marketScenarioStyles[marketScenarioKey].backgroundColor + '1a',
                    borderWidth: 2.5,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0,
                    pointHitRadius: 10
                });
            });
            renderChart(canvasId, workScenario.title, chartLabels, datasets);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Carga los valores guardados al iniciar la página
        loadCapitalFromStorage();
        // Dibuja los gráficos iniciales con los datos por defecto o los cargados
        runAllSimulations(); 
        
        document.getElementById('recalculateButton').addEventListener('click', runAllSimulations);
    });

    </script>
</body>
</html>

