<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Porcentaje Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lucide-icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-800">
                        Calculadora de Porcentaje Final
                    </h1>
                </div>
                <p class="text-gray-600">
                    Calcula el resultado final basado en montos y porcentajes
                </p>
            </div>

            <div id="items-container" class="space-y-6">
                <!-- Los elementos se generarán aquí dinámicamente -->
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-8">
                <button onclick="addItem()" class="flex items-center justify-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    <svg class="lucide-icon mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Añadir Elemento
                </button>
                
                <button onclick="resetToDefault()" class="flex items-center justify-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                    Resetear a Valores por Defecto
                </button>
            </div>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-6 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border border-blue-200">
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                            Suma Inicial
                        </h3>
                        <div id="total-initial" class="text-2xl font-bold text-blue-600">
                            0.00
                        </div>
                        <p class="text-gray-600 text-sm mt-1">
                            Total de montos base
                        </p>
                    </div>
                </div>

                <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-100 rounded-xl border border-green-200">
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                            Incremento Total
                        </h3>
                        <div id="final-result" class="text-2xl font-bold text-green-600">
                            0.00
                        </div>
                        <p class="text-gray-600 text-sm mt-1">
                            Suma de incrementos
                        </p>
                    </div>
                </div>

                <div class="p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border border-purple-200">
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                            % Incremento Total
                        </h3>
                        <div id="percentage-increase" class="text-2xl font-bold text-purple-600">
                            0.00%
                        </div>
                        <p class="text-gray-600 text-sm mt-1">
                            Incremento respecto inicial
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-6 p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        Total Final
                    </h2>
                    <div id="grand-total" class="text-3xl font-bold text-orange-600">
                        0.00
                    </div>
                    <p id="breakdown" class="text-gray-600 mt-1">
                        Suma inicial + incrementos (0 + 0)
                    </p>
                </div>
            </div>

            <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2">Cómo funciona:</h3>
                <div class="text-blue-700 text-sm space-y-1">
                    <p><strong>Incremento parcial:</strong> Monto × Porcentaje ÷ 100</p>
                    <p><strong>% Incremento Total:</strong> (Suma de incrementos ÷ Suma inicial) × 100</p>
                    <p><strong>Total Final:</strong> Suma inicial + Suma de todos los incrementos</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let items = [
            { id: 1, amount: 50000, percentage: 4.14 },
            { id: 2, amount: 40000, percentage: 3.04 },
            { id: 3, amount: 30000, percentage: 2.54 }
        ];
        let nextId = 4;

        // Función para formatear números
        function formatNumber(num) {
            return num.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Función para cargar datos desde localStorage
        function loadFromStorage() {
            const savedItems = localStorage.getItem('calculator-items');
            const savedNextId = localStorage.getItem('calculator-nextId');
            
            if (savedItems) {
                items = JSON.parse(savedItems);
            }
            if (savedNextId) {
                nextId = parseInt(savedNextId);
            }
        }

        // Función para guardar datos en localStorage
        function saveToStorage() {
            localStorage.setItem('calculator-items', JSON.stringify(items));
            localStorage.setItem('calculator-nextId', nextId.toString());
        }

        // Función para crear el HTML de un elemento
        function createItemHTML(item, index) {
            return `
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">
                            Elemento ${index + 1}
                        </h3>
                        ${items.length > 1 ? `
                            <button onclick="removeItem(${item.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors" title="Eliminar elemento">
                                <svg class="lucide-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Monto Base
                            </label>
                            <input
                                type="number"
                                value="${item.amount}"
                                onchange="updateItem(${item.id}, 'amount', this.value)"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                                placeholder="Monto"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Porcentaje (%)
                            </label>
                            <input
                                type="number"
                                step="0.01"
                                value="${item.percentage}"
                                onchange="updateItem(${item.id}, 'percentage', this.value)"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                                placeholder="Porcentaje"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Resultado Parcial
                            </label>
                            <div class="px-3 py-2 text-sm bg-gray-100 border border-gray-300 rounded-lg text-gray-800 font-medium">
                                ${formatNumber(item.amount * item.percentage / 100)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para renderizar todos los elementos
        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = items.map((item, index) => createItemHTML(item, index)).join('');
        }

        // Función para calcular y actualizar los resultados
        function calculateResults() {
            const totalInitial = items.reduce((sum, item) => sum + item.amount, 0);
            const finalResult = items.reduce((sum, item) => sum + (item.amount * item.percentage / 100), 0);
            const percentageIncrease = totalInitial > 0 ? (finalResult / totalInitial) * 100 : 0;
            const grandTotal = totalInitial + finalResult;

            document.getElementById('total-initial').textContent = formatNumber(totalInitial);
            document.getElementById('final-result').textContent = formatNumber(finalResult);
            document.getElementById('percentage-increase').textContent = formatNumber(percentageIncrease) + '%';
            document.getElementById('grand-total').textContent = formatNumber(grandTotal);
            document.getElementById('breakdown').textContent = 
                `Suma inicial + incrementos (${formatNumber(totalInitial)} + ${formatNumber(finalResult)})`;
        }

        // Función para actualizar un elemento
        function updateItem(id, field, value) {
            items = items.map(item => 
                item.id === id 
                    ? { ...item, [field]: parseFloat(value) || 0 }
                    : item
            );
            renderItems();
            calculateResults();
            saveToStorage();
        }

        // Función para añadir un nuevo elemento
        function addItem() {
            const newItem = {
                id: nextId,
                amount: 10000,
                percentage: 2.0
            };
            items.push(newItem);
            nextId++;
            renderItems();
            calculateResults();
            saveToStorage();
        }

        // Función para eliminar un elemento
        function removeItem(id) {
            if (items.length > 1) {
                items = items.filter(item => item.id !== id);
                renderItems();
                calculateResults();
                saveToStorage();
            }
        }

        // Función para resetear a valores por defecto
        function resetToDefault() {
            items = [
                { id: 1, amount: 50000, percentage: 4.14 },
                { id: 2, amount: 40000, percentage: 3.04 },
                { id: 3, amount: 30000, percentage: 2.54 }
            ];
            nextId = 4;
            renderItems();
            calculateResults();
            saveToStorage();
        }

        // Inicializar la aplicación
        function init() {
            loadFromStorage();
            renderItems();
            calculateResults();
        }

        // Ejecutar cuando la página se carga
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>