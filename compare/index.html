<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Estrategias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Laboratorio de Estrategias a 30 Años</h1>
            <p class="text-gray-400 mt-2">Configura y compara 4 universos paralelos para encontrar la estrategia óptima.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Columna de Controles -->
            <div class="lg:w-1/3 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-4 text-white">Configuración de Estrategias</h2>
                
                <div class="space-y-6">
                    <!-- Estrategia 1 -->
                    <details class="bg-gray-900/50 rounded-lg p-4" open>
                        <summary class="font-semibold text-lg text-indigo-300 cursor-pointer">E1: RF a RV (Inmediato)</summary>
                        <div class="mt-4 space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-300">RV Inicial</label>
                                <input type="number" id="s1-rv" value="6000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">RF Inicial</label>
                                <input type="number" id="s1-rf" value="10000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-300">Ahorro Inicial</label>
                                <input type="number" id="s1-cash" value="1500" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                        </div>
                    </details>
                    
                    <!-- Estrategia 2 -->
                    <details class="bg-gray-900/50 rounded-lg p-4" open>
                        <summary class="font-semibold text-lg text-purple-300 cursor-pointer">E2: RF a RV (DCA 1.5 años)</summary>
                        <div class="mt-4 space-y-3">
                             <div>
                                <label class="block text-sm font-medium text-gray-300">RV Inicial</label>
                                <input type="number" id="s2-rv" value="6000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">RF Inicial</label>
                                <input type="number" id="s2-rf" value="10000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-300">Ahorro Inicial</label>
                                <input type="number" id="s2-cash" value="1500" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                        </div>
                    </details>

                    <!-- Estrategia 3 -->
                    <details class="bg-gray-900/50 rounded-lg p-4" open>
                        <summary class="font-semibold text-lg text-yellow-300 cursor-pointer">E3: Ahorro a RV (Inmediato)</summary>
                         <div class="mt-4 space-y-3">
                             <div>
                                <label class="block text-sm font-medium text-gray-300">RV Inicial</label>
                                <input type="number" id="s3-rv" value="6000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">RF Inicial</label>
                                <input type="number" id="s3-rf" value="1500" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-300">Ahorro Inicial</label>
                                <input type="number" id="s3-cash" value="10000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                        </div>
                    </details>

                     <!-- Estrategia 4 -->
                    <details class="bg-gray-900/50 rounded-lg p-4" open>
                        <summary class="font-semibold text-lg text-orange-300 cursor-pointer">E4: Ahorro a RV (DCA 1.5 años)</summary>
                         <div class="mt-4 space-y-3">
                             <div>
                                <label class="block text-sm font-medium text-gray-300">RV Inicial</label>
                                <input type="number" id="s4-rv" value="6000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">RF Inicial</label>
                                <input type="number" id="s4-rf" value="1500" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-300">Ahorro Inicial</label>
                                <input type="number" id="s4-cash" value="10000" class="strategy-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                            </div>
                        </div>
                    </details>
                </div>
                
                <h2 class="text-2xl font-bold my-6 border-b border-gray-700 pb-4 text-white">Configuración Global</h2>

                <!-- Rentabilidades -->
                 <div class="mb-6">
                     <h3 class="text-lg font-semibold mb-3 text-gray-100">Rentabilidades Anuales Promedio</h3>
                     <div class="space-y-3">
                         <div>
                            <label for="rf-return" class="block text-sm font-medium text-gray-300">Renta Fija (%)</label>
                            <input type="number" id="rf-return" value="2.0" class="global-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                        </div>
                        <div>
                            <label for="cash-return" class="block text-sm font-medium text-gray-300">Cuenta Ahorro (%)</label>
                            <input type="number" id="cash-return" value="0.7" class="global-input mt-1 block w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                        </div>
                     </div>
                </div>
                
                 <!-- Escenario de Mercado -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-100">Escenario de Mercado</h3>
                    <select id="market-scenario" class="global-input w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-white">
                        <option value="calma">La Gran Calma</option>
                        <option value="despertar">El Despertar (Crisis Temprana)</option>
                        <option value="benner">Ciclo de Benner (Crisis Intermedia)</option>
                    </select>
                </div>
            </div>

            <!-- Columna de Resultados -->
            <div class="lg:w-2/3 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-white">Resultados de la Comparación</h2>
                <p class="text-gray-400 mb-6">Se simula una aportación de 20.000€ a RV cada 5 años (hasta un total de 100.000€), según las cuatro estrategias.</p>
                
                <canvas id="results-chart" class="mb-8"></canvas>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3">Estrategia</th>
                                <th scope="col" class="px-6 py-3 text-right">Patrimonio Total Final</th>
                                <th scope="col" class="px-6 py-3 text-right">Retorno Total</th>
                                <th scope="col" class="px-6 py-3 text-right">Valor Final RV</th>
                                <th scope="col" class="px-6 py-3 text-right">Valor Final RF + Ahorro</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Filas generadas por JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        rfReturn: document.getElementById('rf-return'),
        cashReturn: document.getElementById('cash-return'),
        marketScenario: document.getElementById('market-scenario'),
        chartCanvas: document.getElementById('results-chart'),
        tableBody: document.getElementById('results-table-body'),
        strategyInputs: document.querySelectorAll('.strategy-input'),
        globalInputs: document.querySelectorAll('.global-input'),
    };

    let chartInstance = null;
    const YEARS = 30;
    const IRPF_RATE = 0.19;

    const scenarios = {
        calma: [12.5, 8.2, 15.1, -5.4, 11.8, 9.3, 22.4, -10.1, 7.5, 14.6, 6.2, 18.9, 11.2, -3.7, 9.8, 13.5, 20.1, 7.8, 10.4, -8.2, 12.1, 15.6, 8.5, 6.7, 11.9, -4.1, 14.2, 9.5, 16.3, 7.1],
        despertar: [8.5, 10.2, -40.0, -15.0, 25.0, 18.0, 12.5, -9.1, 6.4, 11.3, 8.2, -15.7, 14.9, 22.1, 7.6, 10.8, -5.2, 9.3, 11.7, -12.4, 18.2, 9.1, 7.5, 8.8, -6.3, 13.4, 10.2, 9.9, 12.1, 8.7],
        benner: [18.0, -10.0, -5.0, 2.0, 8.0, 15.0, 25.0, -35.0, 15.0, 10.0, -8.0, 5.0, 12.0, 20.0, 30.0, -20.0, -15.0, 10.0, 18.0, -5.0, 22.0, 12.0, 8.0, -12.0, 15.0, 28.0, -25.0, 12.0, 10.0, 5.0]
    };
    
    function runFullComparison() {
        const globalConfig = {
            rfReturn: parseFloat(elements.rfReturn.value) / 100,
            cashReturn: parseFloat(elements.cashReturn.value) / 100,
            sp500Scenario: scenarios[elements.marketScenario.value],
        };

        const strategies = [
            { id: 1, name: 'RF a RV (Inmediato)', source: 'rf', isDca: false },
            { id: 2, name: 'RF a RV (DCA 1.5 años)', source: 'rf', isDca: true },
            { id: 3, name: 'Ahorro a RV (Inmediato)', source: 'cash', isDca: false },
            { id: 4, name: 'Ahorro a RV (DCA 1.5 años)', source: 'cash', isDca: true },
        ];
        
        const results = strategies.map(strategy => {
            const initialConfig = {
                initialRv: parseFloat(document.getElementById(`s${strategy.id}-rv`).value),
                initialRf: parseFloat(document.getElementById(`s${strategy.id}-rf`).value),
                initialCash: parseFloat(document.getElementById(`s${strategy.id}-cash`).value),
            };
            return runSimulation({ ...globalConfig, ...initialConfig }, strategy);
        });

        renderResults(results);
    }

    function runSimulation(config, strategy) {
        let rv = config.initialRv;
        let rf = config.initialRf;
        let rfPrincipal = config.initialRf;
        let cash = config.initialCash;
        let dcaPool = 0;
        
        const totalInvested = rv + rf + cash;

        const OPERATION_AMOUNT = 20000;
        const OPERATION_INTERVAL = 5;
        const DCA_PERIOD = 1.5;

        for (let year = 1; year <= YEARS; year++) {
            // Growth
            rv *= (1 + config.sp500Scenario[year - 1] / 100);
            rf *= (1 + config.rfReturn);
            cash *= (1 + config.cashReturn);
            dcaPool *= (1 + config.cashReturn);

            // Planned transfers
            if (year % OPERATION_INTERVAL === 0 && year > 0 && (year / OPERATION_INTERVAL <= 5)) {
                let netAmountToTransfer = 0;
                
                if (strategy.source === 'rf') {
                    const amountToWithdraw = Math.min(rf, OPERATION_AMOUNT);
                    if (amountToWithdraw > 0) {
                        const totalGain = Math.max(0, rf - rfPrincipal);
                        const gainRatio = rf > 0 ? totalGain / rf : 0;
                        const gainOnWithdrawal = amountToWithdraw * gainRatio;
                        const tax = gainOnWithdrawal * IRPF_RATE;
                        netAmountToTransfer = amountToWithdraw - tax;
                        
                        const principalWithdrawn = amountToWithdraw - gainOnWithdrawal;
                        rfPrincipal -= principalWithdrawn;
                        rf -= amountToWithdraw;
                    }
                } else { // source === 'cash'
                    const amountFromCash = Math.min(cash, OPERATION_AMOUNT);
                    cash -= amountFromCash;
                    netAmountToTransfer = amountFromCash;
                }
                
                if (strategy.isDca) {
                    dcaPool += netAmountToTransfer;
                } else {
                    rv += netAmountToTransfer;
                }
            }

            // Execute DCA if applicable
            if (dcaPool > 0) {
                let activeDcaContribution = 0;
                for (let opYear = OPERATION_INTERVAL; opYear <= 25; opYear += OPERATION_INTERVAL) {
                    if (year >= opYear && year < opYear + DCA_PERIOD) {
                        activeDcaContribution += (OPERATION_AMOUNT / DCA_PERIOD);
                    }
                }
                const amountToInvest = Math.min(dcaPool, activeDcaContribution);
                dcaPool -= amountToInvest;
                rv += amountToInvest;
            }
        }
        
        const finalOtherAssets = rf + cash + dcaPool;
        const finalValue = rv + finalOtherAssets;

        return {
            name: strategy.name,
            finalValue,
            finalRv: rv,
            finalOther: finalOtherAssets,
            return: ((finalValue - totalInvested) / totalInvested) * 100,
        };
    }
    
    function formatCurrency(value) {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);
    }
    
    function renderResults(results) {
        // Render Table
        elements.tableBody.innerHTML = '';
        results.forEach(res => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700 hover:bg-gray-700/50';
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-white">${res.name}</td>
                <td class="px-6 py-4 text-right text-lg font-bold text-white">${formatCurrency(res.finalValue)}</td>
                <td class="px-6 py-4 text-right font-semibold ${res.return >= 0 ? 'text-green-400' : 'text-red-400'}">${res.return.toFixed(2)}%</td>
                <td class="px-6 py-4 text-right">${formatCurrency(res.finalRv)}</td>
                <td class="px-6 py-4 text-right">${formatCurrency(res.finalOther)}</td>
            `;
            elements.tableBody.appendChild(row);
        });

        // Render Chart
        if (chartInstance) {
            chartInstance.destroy();
        }
        const ctx = elements.chartCanvas.getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: results.map(r => r.name),
                datasets: [{
                    label: 'Patrimonio Total Final',
                    data: results.map(r => r.finalValue),
                    backgroundColor: [
                        'rgba(99, 102, 241, 0.7)',
                        'rgba(139, 92, 246, 0.7)',
                        'rgba(234, 179, 8, 0.7)',
                        'rgba(249, 115, 22, 0.7)'
                    ],
                    borderColor: [
                        'rgba(99, 102, 241, 1)',
                        'rgba(139, 92, 246, 1)',
                        'rgba(234, 179, 8, 1)',
                        'rgba(249, 115, 22, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                 plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: (context) => ` ${formatCurrency(context.parsed.x)}`
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: (value) => formatCurrency(value),
                            color: 'rgb(156, 163, 175)'
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                         ticks: { color: 'rgb(209, 213, 219)' }
                    }
                }
            }
        });
    }

    elements.strategyInputs.forEach(input => input.addEventListener('input', runFullComparison));
    elements.globalInputs.forEach(input => input.addEventListener('input', runFullComparison));
    
    // Initial Run
    runFullComparison();
});
</script>
</body>
</html>

