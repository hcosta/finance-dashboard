<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consejero Proactivo Pareto DCA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .traffic-light {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            color: white;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            text-align: center;
        }
        .traffic-light .amount {
            font-size: 2.25rem;
            line-height: 1.1;
        }
        .traffic-light .label {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0.8;
        }
        .light-red {
            background-color: #7f1d1d; /* red-900 */
            border: 5px solid #b91c1c; /* red-700 */
        }
        .light-green {
            background-color: #065f46; /* green-800 */
            border: 5px solid #047857; /* green-600 */
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(4, 120, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(4, 120, 87, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(4, 120, 87, 0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Consejero Proactivo Pareto DCA</h1>
            <p class="text-gray-400 mt-2">Tu única acción de inversión para el día 1 de cada mes.</p>
        </header>

        <main class="bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col gap-8">
            <!-- User Inputs -->
            <div class="bg-gray-700 p-4 rounded-lg">
                <label for="portfolioValue" class="block text-lg font-semibold mb-2 text-white">Introduce el valor total de tu cartera (€)</label>
                <input type="number" id="portfolioValue" class="w-full p-3 bg-gray-900 text-white text-xl font-bold rounded-md border-2 border-transparent focus:border-indigo-500 focus:outline-none" placeholder="Ej: 5000">
            </div>

            <!-- Decision Engine -->
            <div id="decision-engine" class="text-center">
                <div id="loader" class="flex flex-col items-center justify-center h-48">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-400">Consultando datos del S&P 500...</p>
                </div>
                
                <div id="result" class="hidden">
                    <div class="flex flex-col items-center justify-center gap-6">
                        <div id="traffic-light" class="traffic-light">
                             <!-- Content generated by JS -->
                        </div>
                        <div id="action-text" class="text-center">
                            <h2 id="action-title" class="text-2xl font-bold text-white"></h2>
                            <p id="action-subtitle" class="text-gray-400 text-lg mt-1"></p>
                        </div>
                    </div>

                    <div id="calculation-table-container" class="mt-8 hidden">
                        <h3 class="text-xl font-semibold mb-3 text-center text-gray-300">Desglose del Cálculo</h3>
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                            <table class="w-full text-left">
                                <tbody>
                                    <tr class="border-b border-gray-600">
                                        <td class="py-2 pr-4 text-gray-400">Aportación Mínima (Base)</td>
                                        <td id="base-value" class="py-2 text-right font-semibold text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-600">
                                        <td class="py-2 pr-4 text-gray-400">Caída desde Máximos (ATH)</td>
                                        <td id="drawdown-value" class="py-2 text-right font-semibold text-white"></td>
                                    </tr>
                                    <tr class="border-b border-gray-600">
                                        <td class="py-2 pr-4 text-gray-400">Multiplicador Táctico</td>
                                        <td id="multiplier-value" class="py-2 text-right font-semibold text-white"></td>
                                    </tr>
                                     <tr class="border-b border-gray-600">
                                        <td class="py-2 pr-4 text-gray-400">Aportación Táctica Extra</td>
                                        <td id="extra-value" class="py-2 text-right font-semibold text-white"></td>
                                    </tr>
                                    <tr class="bg-gray-900/50">
                                        <td class="py-3 pr-4 font-bold text-lg text-indigo-400">Aportación Total este Mes</td>
                                        <td id="final-value" class="py-3 text-right font-extrabold text-xl text-indigo-400"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-center text-gray-500 pt-4 mt-4 border-t border-gray-700">
                    Última Sincronización: <span id="last-sync-time">Nunca</span>
                </div>
                 <div class="mt-6 text-center">
                    <a id="calendar-link" href="#" target="_blank" class="inline-block bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition text-sm font-semibold">
                        <i class="far fa-calendar-alt mr-2"></i>Crear recordatorio mensual
                    </a>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- DOM ELEMENTS ---
    const portfolioValueInput = document.getElementById('portfolioValue');
    const loader = document.getElementById('loader');
    const resultDiv = document.getElementById('result');
    const trafficLight = document.getElementById('traffic-light');
    const actionTitle = document.getElementById('action-title');
    const actionSubtitle = document.getElementById('action-subtitle');
    const tableContainer = document.getElementById('calculation-table-container');
    const lastSyncTime = document.getElementById('last-sync-time');
    const calendarLink = document.getElementById('calendar-link');

    // --- STATE MANAGEMENT ---
    let state = {
        portfolioValue: 0,
        marketData: {
            currentPrice: 0,
            ath: 0,
            lastSync: null
        }
    };

    function saveState() {
        localStorage.setItem('proactiveAdvisorState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('proactiveAdvisorState');
        if (savedState) {
            state = JSON.parse(savedState);
            portfolioValueInput.value = state.portfolioValue > 0 ? state.portfolioValue : '';
        }
    }

    // --- API & DATA FETCHING ---
    function getApiKey() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('apikey'); 
    }

    async function fetchMarketData() {
        const now = new Date();
        const lastSync = state.marketData.lastSync ? new Date(state.marketData.lastSync) : null;

        if (lastSync && (now - lastSync < 30 * 60 * 1000)) {
            console.log("Using cached market data.");
            updateUI();
            return;
        }

        const apiKey = getApiKey();
        const symbol = 'SPY';

        if (!apiKey) {
            console.error("API Key not provided. Please add ?apikey=YOUR_KEY to the URL.");
            state.marketData.ath = 550;
            state.marketData.currentPrice = 500;
            const existingError = document.querySelector('.api-error-message');
            if(existingError) existingError.remove();
            actionSubtitle.insertAdjacentHTML('beforeend', `<br><span class='text-xs text-yellow-400 api-error-message'>Falta la API Key. Usando datos de ejemplo.</span>`);
            updateUI();
            return;
        }

        try {
            console.log("Fetching new market data...");
            const timeSeriesUrl = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1month&outputsize=500&apikey=${apiKey}`;
            const quoteUrl = `https://api.twelvedata.com/quote?symbol=${symbol}&apikey=${apiKey}`;

            const [timeSeriesRes, quoteRes] = await Promise.all([
                fetch(timeSeriesUrl),
                fetch(quoteUrl)
            ]);

            const timeSeriesData = await timeSeriesRes.json();
            const quoteData = await quoteRes.json();
            
            if (timeSeriesData.status === 'error' || (timeSeriesData.code && timeSeriesData.code >= 400) || !timeSeriesData.values) {
                throw new Error(timeSeriesData.message || 'Error fetching time series data.');
            }
            if (quoteData.status === 'error' || (quoteData.code && quoteData.code >= 400) || !quoteData.close) {
                throw new Error(quoteData.message || 'Error fetching quote data.');
            }
            
            const highs = timeSeriesData.values.map(v => parseFloat(v.high)).filter(h => !isNaN(h)); 
            const ath = highs.length > 0 ? Math.max(...highs) : 0;
            const currentPrice = parseFloat(quoteData.close);

            state.marketData = { currentPrice, ath, lastSync: new Date().toISOString() };
            // FIX: Save state to localStorage after a successful API fetch
            saveState(); 
            
        } catch (error) {
            console.error("API Error:", error.message);
            // Use cached data if available, otherwise use fallback
            if (!state.marketData.ath || state.marketData.ath === 0) {
                 state.marketData.ath = 550;
                 state.marketData.currentPrice = 500;
                 const existingError = document.querySelector('.api-error-message');
                 if(existingError) existingError.remove();
                 actionSubtitle.insertAdjacentHTML('beforeend', `<br><span class='text-xs text-yellow-400 api-error-message'>Error de API. Revisa la consola y tu API Key.</span>`);
            }
        } finally {
            updateUI();
        }
    }

    // --- CALCULATIONS ---
    function calculateInvestment() {
        const { portfolioValue } = state;
        const { currentPrice, ath } = state.marketData;

        // FIX: Decoupled drawdown calculation from portfolio value
        // Primero, calcula las condiciones del mercado independientemente de la cartera
        let drawdown = 0;
        if (ath > 0) {
            drawdown = ((currentPrice - ath) / ath) * 100;
        }

        // Si no hay valor de cartera, devuelve el drawdown pero sin cálculos de inversión
        if (portfolioValue <= 0) {
            return { minContribution: 0, drawdown, multiplier: 0, extraInvestment: 0, totalInvestment: 0, isTactical: false };
        }
        
        const minContribution = (portfolioValue * 0.005) + 150;

        if (drawdown > -10) {
            return { minContribution, drawdown, multiplier: 0, extraInvestment: 0, totalInvestment: minContribution, isTactical: false };
        }

        const positiveDrawdown = Math.abs(drawdown);
        const convictionPower = 1.2;
        const multiplier = Math.pow((positiveDrawdown / 10), convictionPower);
        const extraInvestment = minContribution * multiplier;
        const totalInvestment = minContribution + extraInvestment;

        return { minContribution, drawdown, multiplier, extraInvestment, totalInvestment, isTactical: true };
    }

    // --- UI RENDERING ---
    function updateUI() {
        loader.classList.add('hidden');
        resultDiv.classList.remove('hidden');

        if (state.marketData.lastSync) {
            lastSyncTime.textContent = new Date(state.marketData.lastSync).toLocaleString('es-ES');
        }

        const results = calculateInvestment();
        
        const formattedTotal = results.totalInvestment.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });

        if (results.isTactical) {
            // GREEN LIGHT
            trafficLight.className = "traffic-light light-green";
            trafficLight.innerHTML = `<span class="label">Invertir este mes</span><span class="amount">${formattedTotal}</span>`;
            actionTitle.textContent = "¡Oportunidad Táctica Detectada!";
            actionSubtitle.textContent = `La caída del mercado del ${results.drawdown.toFixed(2)}% activa una aportación extra.`;
            tableContainer.classList.remove('hidden');

            // Populate table
            document.getElementById('base-value').textContent = results.minContribution.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
            document.getElementById('drawdown-value').textContent = `${results.drawdown.toFixed(2)}%`;
            document.getElementById('multiplier-value').textContent = `${results.multiplier.toFixed(2)}x`;
            document.getElementById('extra-value').textContent = results.extraInvestment.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
            document.getElementById('final-value').textContent = formattedTotal;

        } else {
            // RED LIGHT
            trafficLight.className = "traffic-light light-red";
             trafficLight.innerHTML = `<span class="label">Invertir este mes</span><span class="amount">${formattedTotal}</span>`;
            actionTitle.textContent = "Realiza tu Aportación Base";
            let subtitle = "El mercado no ofrece una oportunidad táctica.";
             if (state.marketData.ath > 0) {
                 subtitle += ` (Caída actual: ${results.drawdown.toFixed(2)}%)`;
            }
            actionSubtitle.innerHTML = subtitle;
            tableContainer.classList.add('hidden');
        }
    }
    
    function setupCalendarLink() {
        const title = encodeURIComponent('Día de Inversión: Revisar Consejero Pareto DCA');
        const details = encodeURIComponent('Es día 1, toca revisar la web app para saber la cantidad a invertir este mes. Enlace: ' + window.location.href);
        const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&recur=RRULE:FREQ=MONTHLY`;
        calendarLink.href = googleCalendarUrl;
    }

    // --- EVENT LISTENERS ---
    portfolioValueInput.addEventListener('input', (e) => {
        state.portfolioValue = parseFloat(e.target.value) || 0;
        saveState();
        if (state.marketData.ath > 0) {
            updateUI();
        }
    });

    // --- INITIALIZATION ---
    loadState();
    fetchMarketData();
    setupCalendarLink();
});
</script>

</body>
</html>