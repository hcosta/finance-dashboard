<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Sistémico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .traffic-light {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            color: white;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            text-align: center;
        }
        .traffic-light .status {
            font-size: 2.5rem;
            line-height: 1.1;
        }
        .traffic-light .label {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0.8;
            margin-top: 8px;
        }
        .light-red {
            background-color: #7f1d1d; /* red-900 */
            border: 6px solid #b91c1c; /* red-700 */
        }
        .light-green {
            background-color: #065f46; /* green-800 */
            border: 6px solid #047857; /* green-600 */
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.97); box-shadow: 0 0 0 0 rgba(4, 120, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(4, 120, 87, 0); }
            100% { transform: scale(0.97); box-shadow: 0 0 0 0 rgba(4, 120, 87, 0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Panel de Control Sistémico</h1>
            <p class="text-gray-400 mt-2">Tu única herramienta de decisión para la Renta Variable.</p>
        </header>

        <main class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div id="decision-engine" class="text-center">
                <div id="loader" class="flex flex-col items-center justify-center h-64">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-400">Consultando datos de Vanguard FTSE All-World (VWCE)...</p>
                </div>
                
                <div id="result" class="hidden">
                    <div class="flex flex-col items-center justify-center gap-6">
                        <div id="traffic-light" class="traffic-light">
                             <!-- Contenido generado por JS -->
                        </div>
                        <div id="action-text" class="text-center">
                            <h2 id="action-title" class="text-2xl font-bold text-white"></h2>
                            <p id="action-subtitle" class="text-gray-400 text-lg mt-1"></p>
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="bg-gray-700/50 p-4 rounded-lg">
                             <p class="text-sm text-gray-500 text-center mb-2">Señal basada en el Vanguard FTSE All-World (VWCE.DEX)</p>
                            <table class="w-full text-left text-lg">
                                <tbody>
                                    <tr class="border-b border-gray-600">
                                        <td class="py-3 pr-4 text-gray-400">Precio Actual (VWCE)</td>
                                        <td id="current-price" class="py-3 text-right font-semibold text-white"></td>
                                    </tr>
                                    <tr >
                                        <td class="py-3 pr-4 text-gray-400">Media Móvil (MMS200)</td>
                                        <td id="sma-200" class="py-3 text-right font-semibold text-white"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-center text-gray-500 pt-4 mt-4 border-t border-gray-700">
                    Última Sincronización: <span id="last-sync-time">Nunca</span>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- DOM ELEMENTS ---
    const loader = document.getElementById('loader');
    const resultDiv = document.getElementById('result');
    const trafficLight = document.getElementById('traffic-light');
    const actionTitle = document.getElementById('action-title');
    const actionSubtitle = document.getElementById('action-subtitle');
    const lastSyncTime = document.getElementById('last-sync-time');
    const currentPriceEl = document.getElementById('current-price');
    const sma200El = document.getElementById('sma-200');

    // --- STATE MANAGEMENT ---
    let marketData = {
        currentPrice: 0,
        sma200: 0,
        lastSync: null
    };

    function saveState() {
        localStorage.setItem('systemicControlPanelData_VWCE', JSON.stringify(marketData));
    }

    function loadState() {
        const savedData = localStorage.getItem('systemicControlPanelData_VWCE');
        if (savedData) {
            marketData = JSON.parse(savedData);
        }
    }

    // --- API & DATA FETCHING ---
    // IMPORTANTE: Consigue una API Key gratuita de Alpha Vantage y añádela a la URL.
    // Ejemplo: file:///.../index.html?apikey=TU_API_KEY_AQUI
    function getApiKey() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('apikey'); 
    }

    async function fetchMarketData() {
        const now = new Date();
        const lastSync = marketData.lastSync ? new Date(marketData.lastSync) : null;

        // Tu estrategia de caché: usar datos guardados si tienen menos de 1 hora.
        if (lastSync && (now - lastSync < 60 * 60 * 1000)) {
            console.log("Usando datos de mercado cacheados para VWCE.");
            updateUI();
            return;
        }
        
        loader.classList.remove('hidden');
        resultDiv.classList.add('hidden');

        const apiKey = getApiKey();
        // **CAMBIO:** Usamos el ticker de VWCE en la bolsa XETRA (DEX) para Alpha Vantage
        const symbol = 'VWCE.DEX'; 

        if (!apiKey) {
            console.error("API Key de Alpha Vantage no proporcionada. Añade ?apikey=YOUR_KEY a la URL.");
            handleApiError("Falta la API Key. Usando datos de ejemplo.");
            return;
        }

        try {
            console.log(`Buscando nuevos datos de mercado para ${symbol}...`);
            const smaUrl = `https://www.alphavantage.co/query?function=SMA&symbol=${symbol}&interval=daily&time_period=200&series_type=close&apikey=${apiKey}`;
            const quoteUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;

            const [smaRes, quoteRes] = await Promise.all([
                fetch(smaUrl),
                fetch(quoteUrl)
            ]);

            const smaData = await smaRes.json();
            const quoteData = await quoteRes.json();
            
            // Verificación de errores y límites de la API de Alpha Vantage
            if (smaData['Error Message'] || !smaData['Technical Analysis: SMA']) {
                throw new Error(smaData['Error Message'] || smaData['Information'] || 'Error al obtener la MMS200 de Alpha Vantage.');
            }
            if (quoteData['Error Message'] || !quoteData['Global Quote'] || !quoteData['Global Quote']['05. price']) {
                throw new Error(quoteData['Error Message'] || quoteData['Information'] || 'Error al obtener el precio actual de Alpha Vantage.');
            }
            
            // Obtenemos el último valor disponible del SMA
            const smaValues = smaData['Technical Analysis: SMA'];
            const lastSmaDate = Object.keys(smaValues)[0];
            marketData.sma200 = parseFloat(smaValues[lastSmaDate]['SMA']);

            // Obtenemos el precio actual
            marketData.currentPrice = parseFloat(quoteData['Global Quote']['05. price']);
            marketData.lastSync = new Date().toISOString();
            
            saveState();
            
        } catch (error) {
            console.error("Error de API:", error.message);
            handleApiError(error.message);
        } finally {
            updateUI();
        }
    }

    function handleApiError(message) {
        if (!marketData.sma200 || marketData.sma200 === 0) {
             marketData.sma200 = 120;
             marketData.currentPrice = 125;
        }
        const existingError = document.querySelector('.api-error-message');
        if(existingError) existingError.remove();
        actionSubtitle.insertAdjacentHTML('beforeend', `<br><span class='text-xs text-yellow-400 api-error-message'>Error: ${message}</span>`);
        updateUI();
    }


    // --- UI RENDERING ---
    function updateUI() {
        loader.classList.add('hidden');
        resultDiv.classList.remove('hidden');

        if (marketData.lastSync) {
            lastSyncTime.textContent = new Date(marketData.lastSync).toLocaleString('es-ES', {dateStyle: 'short', timeStyle: 'medium'});
        }

        const { currentPrice, sma200 } = marketData;
        const isInverted = currentPrice > sma200;

        currentPriceEl.textContent = currentPrice.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
        sma200El.textContent = sma200.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });


        if (isInverted) {
            trafficLight.className = "traffic-light light-green";
            trafficLight.innerHTML = `<span class="status">INVERTIDO</span><span class="label">Tendencia Alcista</span>`;
            actionTitle.textContent = "Acción: Mantener Posición";
            actionSubtitle.innerHTML = "El sistema está en modo crecimiento. No se requiere ninguna acción de venta.";
            
            currentPriceEl.classList.add('text-green-400');
            currentPriceEl.classList.remove('text-red-400');
        } else {
            trafficLight.className = "traffic-light light-red";
            trafficLight.innerHTML = `<span class="status">LIQUIDEZ</span><span class="label">Tendencia Bajista</span>`;
            actionTitle.textContent = "Acción: Proteger Capital";
            actionSubtitle.innerHTML = "El capital debe estar en Pólvora Seca. Ejecutar venta si hay posición.";
            
            currentPriceEl.classList.add('text-red-400');
            currentPriceEl.classList.remove('text-green-400');
        }
    }
    
    // --- INITIALIZATION ---
    loadState();
    fetchMarketData();
});
</script>

</body>
</html>

