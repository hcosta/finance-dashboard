<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Inversiones - Renta Variable vs Renta Fija</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .main-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .actions-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .action-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .action-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .action-inputs {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .action-inputs input, .action-inputs select {
            width: 100%;
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .list-item button {
            padding: 5px 10px;
            font-size: 0.85em;
            background: #dc3545;
        }
        
        .list-item button.edit {
            background: #28a745;
            margin-right: 5px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            margin-bottom: 30px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .file-actions button {
            background: #28a745;
        }
        
        .file-actions button.reset {
            background: #dc3545;
        }
        
        .file-actions button.export {
            background: #17a2b8;
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📈 Simulador de Inversiones: Renta Variable vs Renta Fija</h1>
        
        <div class="main-controls">
            <div class="control-group">
                <label>Capital Inicial RV (€)</label>
                <input type="number" id="initialCapitalRV" value="5000" min="0">
            </div>
            <div class="control-group">
                <label>Capital Inicial RF (€)</label>
                <input type="number" id="initialCapitalRF" value="5000" min="0">
            </div>
            <div class="control-group">
                <label>Años de Inversión</label>
                <input type="number" id="years" value="10" min="1" max="50">
            </div>
            <div class="control-group">
                <label>Rentabilidad RV (%)</label>
                <input type="number" id="rvReturn" value="7" step="0.1">
            </div>
            <div class="control-group">
                <label>Rentabilidad RF (%)</label>
                <input type="number" id="rfReturn" value="3" step="0.1">
            </div>
        </div>
        
        <div class="summary" id="summary">
            <div class="summary-item">
                <div class="summary-label">Valor Final RV</div>
                <div class="summary-value" id="rvFinal">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Valor Final RF</div>
                <div class="summary-value" id="rfFinal">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Valor Final Total</div>
                <div class="summary-value" id="totalFinal" style="color: #FFD700;">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Aportado RV</div>
                <div class="summary-value" id="rvContributed">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Aportado RF</div>
                <div class="summary-value" id="rfContributed">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Total Aportado</div>
                <div class="summary-value" id="totalContributed">€0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Rentabilidad Total</div>
                <div class="summary-value" id="totalReturn">0%</div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="investmentChart"></canvas>
        </div>
        
        <div class="actions-section">
            <div class="action-card">
                <h3>💰 Aportaciones</h3>
                <div class="action-inputs">
                    <input type="month" id="contribDate" placeholder="Fecha inicio">
                    <input type="number" id="contribAmount" placeholder="Cantidad (€)" min="0">
                    <select id="contribPeriod">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="yearly">Anual</option>
                    </select>
                    <input type="number" id="contribTimes" placeholder="Número de veces" min="1">
                    <select id="contribTarget">
                        <option value="rv">Renta Variable</option>
                        <option value="rf">Renta Fija</option>
                    </select>
                </div>
                <button onclick="addContribution()">Añadir Aportación</button>
                <div class="list-container" id="contributionsList"></div>
            </div>
            
            <div class="action-card-column">
                <div class="action-card">
                    <h3>📉 Correcciones/Crisis (RV)</h3>
                    <div class="action-inputs">
                        <input type="month" id="crisisDate" placeholder="Fecha">
                        <input type="number" id="crisisPercent" placeholder="Caída (%)" min="0" max="100">
                    </div>
                    <button onclick="addCrisis()">Añadir Crisis</button>
                    <div class="list-container" id="crisisList"></div>
                </div>
                
                <div class="action-card">
                    <h3>📝 Observaciones</h3>
                    <textarea id="observations" placeholder="Escribe aquí tus notas sobre la simulación..." 
                              style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #e0e0e0; 
                                     border-radius: 8px; font-family: inherit; font-size: 0.95em; resize: vertical;"
                              oninput="saveObservations()"></textarea>
                </div>
            </div>
            
            <div class="action-card">
                <h3>🔄 Transferencias</h3>
                <div class="action-inputs">
                    <input type="month" id="transferDate" placeholder="Fecha">
                    <input type="number" id="transferAmount" placeholder="Cantidad (€)" min="0">
                    <select id="transferDirection">
                        <option value="rv-rf">RV → RF</option>
                        <option value="rf-rv">RF → RV</option>
                    </select>
                </div>
                <button onclick="addTransfer()">Añadir Transferencia</button>
                <div class="list-container" id="transfersList"></div>
            </div>
        </div>
        
        <div class="file-actions">
            <button onclick="resetAll()" class="reset">🔄 Resetear Todo</button>
            <button onclick="exportData()" class="export">💾 Exportar JSON</button>
            <button onclick="document.getElementById('fileInput').click()">📂 Importar JSON</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <script>
        // Estado de la aplicación
        let state = {
            initialCapitalRV: 5000,
            initialCapitalRF: 5000,
            years: 10,
            rvReturn: 7,
            rfReturn: 3,
            contributions: [],
            crises: [],
            transfers: [],
            observations: ''
        };

        let chart = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadFromMemory();
            setupEventListeners();
            updateSimulation();
        });

        function setupEventListeners() {
            ['initialCapitalRV', 'initialCapitalRF', 'years', 'rvReturn', 'rfReturn'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    updateStateFromInputs();
                    updateSimulation();
                });
            });
        }

        function updateStateFromInputs() {
            state.initialCapitalRV = parseFloat(document.getElementById('initialCapitalRV').value) || 0;
            state.initialCapitalRF = parseFloat(document.getElementById('initialCapitalRF').value) || 0;
            state.years = parseInt(document.getElementById('years').value) || 1;
            state.rvReturn = parseFloat(document.getElementById('rvReturn').value) || 0;
            state.rfReturn = parseFloat(document.getElementById('rfReturn').value) || 0;
            saveToMemory();
        }

        function addContribution() {
            const date = document.getElementById('contribDate').value;
            const amount = parseFloat(document.getElementById('contribAmount').value);
            const period = document.getElementById('contribPeriod').value;
            const times = parseInt(document.getElementById('contribTimes').value);
            const target = document.getElementById('contribTarget').value;
            
            if (!date || !amount || !times) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            const contribution = { id: Date.now(), date, amount, period, times, target };
            state.contributions.push(contribution);
            
            updateContributionsList();
            updateSimulation();
            saveToMemory();
            
            // Limpiar campos
            document.getElementById('contribDate').value = '';
            document.getElementById('contribAmount').value = '';
            document.getElementById('contribTimes').value = '';
        }

        function addCrisis() {
            const date = document.getElementById('crisisDate').value;
            const percent = parseFloat(document.getElementById('crisisPercent').value);
            
            if (!date || !percent) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            const crisis = { id: Date.now(), date, percent };
            state.crises.push(crisis);
            
            updateCrisisList();
            updateSimulation();
            saveToMemory();
            
            // Limpiar campos
            document.getElementById('crisisDate').value = '';
            document.getElementById('crisisPercent').value = '';
        }

        function addTransfer() {
            const date = document.getElementById('transferDate').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const direction = document.getElementById('transferDirection').value;
            
            if (!date || !amount) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            const transfer = { id: Date.now(), date, amount, direction };
            state.transfers.push(transfer);
            
            updateTransfersList();
            updateSimulation();
            saveToMemory();
            
            // Limpiar campos
            document.getElementById('transferDate').value = '';
            document.getElementById('transferAmount').value = '';
        }

        function updateContributionsList() {
            const list = document.getElementById('contributionsList');
            list.innerHTML = state.contributions.map(c => `
                <div class="list-item">
                    <span>${c.date} - €${c.amount} - ${c.period} - ${c.times}x - ${c.target.toUpperCase()}</span>
                    <div>
                        <button class="edit" onclick="editContribution(${c.id})">✏️</button>
                        <button onclick="deleteContribution(${c.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function updateCrisisList() {
            const list = document.getElementById('crisisList');
            list.innerHTML = state.crises.map(c => `
                <div class="list-item">
                    <span>${c.date} - Caída ${c.percent}%</span>
                    <div>
                        <button class="edit" onclick="editCrisis(${c.id})">✏️</button>
                        <button onclick="deleteCrisis(${c.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function updateTransfersList() {
            const list = document.getElementById('transfersList');
            list.innerHTML = state.transfers.map(t => `
                <div class="list-item">
                    <span>${t.date} - €${t.amount} - ${t.direction === 'rv-rf' ? 'RV→RF' : 'RF→RV'}</span>
                    <div>
                        <button class="edit" onclick="editTransfer(${t.id})">✏️</button>
                        <button onclick="deleteTransfer(${t.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteContribution(id) {
            state.contributions = state.contributions.filter(c => c.id !== id);
            updateContributionsList();
            updateSimulation();
            saveToMemory();
        }

        function deleteCrisis(id) {
            state.crises = state.crises.filter(c => c.id !== id);
            updateCrisisList();
            updateSimulation();
            saveToMemory();
        }

        function deleteTransfer(id) {
            state.transfers = state.transfers.filter(t => t.id !== id);
            updateTransfersList();
            updateSimulation();
            saveToMemory();
        }

        function editContribution(id) {
            const contrib = state.contributions.find(c => c.id === id);
            if (contrib) {
                document.getElementById('contribDate').value = contrib.date;
                document.getElementById('contribAmount').value = contrib.amount;
                document.getElementById('contribPeriod').value = contrib.period;
                document.getElementById('contribTimes').value = contrib.times;
                document.getElementById('contribTarget').value = contrib.target;
                deleteContribution(id);
            }
        }

        function editCrisis(id) {
            const crisis = state.crises.find(c => c.id === id);
            if (crisis) {
                document.getElementById('crisisDate').value = crisis.date;
                document.getElementById('crisisPercent').value = crisis.percent;
                deleteCrisis(id);
            }
        }

        function editTransfer(id) {
            const transfer = state.transfers.find(t => t.id === id);
            if (transfer) {
                document.getElementById('transferDate').value = transfer.date;
                document.getElementById('transferAmount').value = transfer.amount;
                document.getElementById('transferDirection').value = transfer.direction;
                deleteTransfer(id);
            }
        }

        function calculateSimulation() {
            const startDate = new Date();
            const months = state.years * 12;
            const monthlyRvReturn = Math.pow(1 + state.rvReturn / 100, 1/12) - 1;
            const monthlyRfReturn = Math.pow(1 + state.rfReturn / 100, 1/12) - 1;
            
            let rvValues = [state.initialCapitalRV];
            let rfValues = [state.initialCapitalRF];
            let labels = ['Inicio'];
            let rvContributed = state.initialCapitalRV;
            let rfContributed = state.initialCapitalRF;
            
            for (let month = 1; month <= months; month++) {
                const currentDate = new Date(startDate);
                currentDate.setMonth(startDate.getMonth() + month);
                const dateStr = currentDate.toISOString().slice(0, 7);
                
                let rvValue = rvValues[rvValues.length - 1] * (1 + monthlyRvReturn);
                let rfValue = rfValues[rfValues.length - 1] * (1 + monthlyRfReturn);
                
                // Aplicar aportaciones
                state.contributions.forEach(contrib => {
                    const contribDate = new Date(contrib.date);
                    const monthsDiff = (currentDate.getFullYear() - contribDate.getFullYear()) * 12 + 
                                      (currentDate.getMonth() - contribDate.getMonth());
                    
                    let shouldAdd = false;
                    if (contrib.period === 'monthly' && monthsDiff >= 0 && monthsDiff < contrib.times) {
                        shouldAdd = true;
                    } else if (contrib.period === 'quarterly' && monthsDiff >= 0 && monthsDiff % 3 === 0 && monthsDiff / 3 < contrib.times) {
                        shouldAdd = true;
                    } else if (contrib.period === 'yearly' && monthsDiff >= 0 && monthsDiff % 12 === 0 && monthsDiff / 12 < contrib.times) {
                        shouldAdd = true;
                    }
                    
                    if (shouldAdd) {
                        if (contrib.target === 'rv') {
                            rvValue += contrib.amount;
                            rvContributed += contrib.amount;
                        } else {
                            rfValue += contrib.amount;
                            rfContributed += contrib.amount;
                        }
                    }
                });
                
                // Aplicar crisis
                state.crises.forEach(crisis => {
                    if (crisis.date === dateStr) {
                        rvValue *= (1 - crisis.percent / 100);
                    }
                });
                
                // Aplicar transferencias
                state.transfers.forEach(transfer => {
                    if (transfer.date === dateStr) {
                        if (transfer.direction === 'rv-rf') {
                            const amount = Math.min(transfer.amount, rvValue);
                            rvValue -= amount;
                            rfValue += amount;
                        } else {
                            const amount = Math.min(transfer.amount, rfValue);
                            rfValue -= amount;
                            rvValue += amount;
                        }
                    }
                });
                
                rvValues.push(rvValue);
                rfValues.push(rfValue);
                
                if (month % 12 === 0) {
                    labels.push(`Año ${month / 12}`);
                }
            }
            
            return { rvValues, rfValues, labels, rvContributed, rfContributed };
        }

        function updateSimulation() {
            const { rvValues, rfValues, labels, rvContributed, rfContributed } = calculateSimulation();
            
            // Actualizar resumen
            const rvFinal = rvValues[rvValues.length - 1];
            const rfFinal = rfValues[rfValues.length - 1];
            const totalFinal = rvFinal + rfFinal;
            const totalContributed = rvContributed + rfContributed;
            const totalReturn = totalContributed > 0 ? ((totalFinal - totalContributed) / totalContributed * 100) : 0;
            
            document.getElementById('rvFinal').textContent = `€${rvFinal.toFixed(2)}`;
            document.getElementById('rfFinal').textContent = `€${rfFinal.toFixed(2)}`;
            document.getElementById('totalFinal').textContent = `€${totalFinal.toFixed(2)}`;
            document.getElementById('rvContributed').textContent = `€${rvContributed.toFixed(2)}`;
            document.getElementById('rfContributed').textContent = `€${rfContributed.toFixed(2)}`;
            document.getElementById('totalContributed').textContent = `€${totalContributed.toFixed(2)}`;
            document.getElementById('totalReturn').textContent = `${totalReturn.toFixed(2)}%`;
            
            // Actualizar gráfico
            updateChart(rvValues, rfValues, labels);
        }

        function updateChart(rvValues, rfValues, labels) {
            const ctx = document.getElementById('investmentChart').getContext('2d');
            
            // Filtrar valores para mostrar solo puntos anuales en el gráfico
            const annualRvValues = [];
            const annualRfValues = [];
            for (let i = 0; i < rvValues.length; i += 12) {
                annualRvValues.push(rvValues[i]);
                annualRfValues.push(rfValues[i]);
            }
            if (rvValues.length % 12 !== 0) {
                annualRvValues.push(rvValues[rvValues.length - 1]);
                annualRfValues.push(rfValues[rfValues.length - 1]);
            }
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Renta Variable',
                            data: annualRvValues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Renta Fija',
                            data: annualRfValues,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': €' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function saveObservations() {
            state.observations = document.getElementById('observations').value;
            saveToMemory();
        }

        function saveToMemory() {
            // Guardamos en localStorage real para uso fuera de Claude.ai
            try {
                localStorage.setItem('investmentSimulatorState', JSON.stringify(state));
            } catch (e) {
                // Si falla localStorage (en Claude.ai), usamos memoria JavaScript
                window.savedState = JSON.parse(JSON.stringify(state));
            }
        }

        function loadFromMemory() {
            // Intentamos cargar desde localStorage primero
            try {
                const saved = localStorage.getItem('investmentSimulatorState');
                if (saved) {
                    state = JSON.parse(saved);
                    
                    // Actualizar inputs
                    document.getElementById('initialCapitalRV').value = state.initialCapitalRV;
                    document.getElementById('initialCapitalRF').value = state.initialCapitalRF;
                    document.getElementById('years').value = state.years;
                    document.getElementById('rvReturn').value = state.rvReturn;
                    document.getElementById('rfReturn').value = state.rfReturn;
                    
                    // Actualizar observaciones
                    if (state.observations) {
                        document.getElementById('observations').value = state.observations;
                    }
                    
                    // Actualizar listas
                    updateContributionsList();
                    updateCrisisList();
                    updateTransfersList();
                    return;
                }
            } catch (e) {
                // Si localStorage no está disponible, intentamos memoria JavaScript
                if (window.savedState) {
                    state = JSON.parse(JSON.stringify(window.savedState));
                    
                    // Actualizar inputs
                    document.getElementById('initialCapitalRV').value = state.initialCapitalRV;
                    document.getElementById('initialCapitalRF').value = state.initialCapitalRF;
                    document.getElementById('years').value = state.years;
                    document.getElementById('rvReturn').value = state.rvReturn;
                    document.getElementById('rfReturn').value = state.rfReturn;
                    
                    // Actualizar observaciones
                    if (state.observations) {
                        document.getElementById('observations').value = state.observations;
                    }
                    
                    // Actualizar listas
                    updateContributionsList();
                    updateCrisisList();
                    updateTransfersList();
                }
            }
        }

        function resetAll() {
            if (confirm('¿Estás seguro de que quieres resetear todo?')) {
                state = {
                    initialCapitalRV: 5000,
                    initialCapitalRF: 5000,
                    years: 10,
                    rvReturn: 7,
                    rfReturn: 3,
                    contributions: [],
                    crises: [],
                    transfers: [],
                    observations: ''
                };
                
                document.getElementById('initialCapitalRV').value = state.initialCapitalRV;
                document.getElementById('initialCapitalRF').value = state.initialCapitalRF;
                document.getElementById('years').value = state.years;
                document.getElementById('rvReturn').value = state.rvReturn;
                document.getElementById('rfReturn').value = state.rfReturn;
                document.getElementById('observations').value = '';
                
                updateContributionsList();
                updateCrisisList();
                updateTransfersList();
                updateSimulation();
                
                // Limpiar localStorage también
                try {
                    localStorage.removeItem('investmentSimulatorState');
                } catch (e) {
                    // Si falla, limpiamos memoria JavaScript
                    window.savedState = null;
                }
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `simulacion_inversiones_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        state = JSON.parse(e.target.result);
                        
                        // Actualización de los inputs existentes
                        document.getElementById('initialCapitalRV').value = state.initialCapitalRV;
                        document.getElementById('initialCapitalRF').value = state.initialCapitalRF;
                        document.getElementById('years').value = state.years;
                        document.getElementById('rvReturn').value = state.rvReturn;
                        document.getElementById('rfReturn').value = state.rfReturn;

                        // --- LÍNEA AÑADIDA ---
                        // Aquí actualizamos el textarea de las observaciones
                        document.getElementById('observations').value = state.observations || '';
                        // ---------------------
                        
                        updateContributionsList();
                        updateCrisisList();
                        updateTransfersList();
                        updateSimulation();
                        saveToMemory();
                        
                        alert('Datos importados correctamente');
                    } catch (error) {
                        alert('Error al importar el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>