<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Inversión a Largo Plazo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem; width: 100%; max-width: 32rem; transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal.active .modal-content { transform: scale(1); }
        .table-container { max-height: 590px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">Simulador de Inversión Avanzado</h1>
            <p class="text-gray-600 mt-2">Proyecta tu patrimonio, planifica aportaciones, simula crisis y rebalancea tu cartera.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Controles -->
            <div class="lg:col-span-1 space-y-6">
                 <!-- Escenarios y Gestión de Datos -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">Escenario Económico</h2>
                    <select id="scenario-select" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="manual">Manual</option>
                        <option value="negativo">Negativo</option>
                        <option value="neutro">Neutro</option>
                        <option value="positivo">Positivo</option>
                    </select>
                    <div class="flex space-x-2 mt-4">
                        <button id="export-data" class="w-full px-4 py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 text-sm">Exportar</button>
                        <button id="import-data" class="w-full px-4 py-2 rounded-lg font-semibold text-white bg-gray-600 hover:bg-gray-700 text-sm">Importar</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>

                <!-- Patrimonio Inicial -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">Patrimonio Inicial y Crecimiento</h2>
                    <div id="patrimonio-inputs" class="space-y-4">
                        <!-- Campos generados por JS -->
                    </div>
                </div>

                <!-- Parámetros de Simulación -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">Parámetros de Simulación</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="anos" class="block mb-2 text-sm font-medium text-gray-700">Años a Simular</label>
                            <input type="number" id="anos" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" value="30">
                        </div>
                        <!-- NUEVO: Campo de Inflación -->
                        <div>
                            <label for="inflacion" class="block mb-2 text-sm font-medium text-gray-700">Inflación Anual Media (%)</label>
                            <input type="number" id="inflacion" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" value="2.5" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Eventos -->
                <div class="space-y-6">
                    <!-- Aportaciones DCA -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Aportaciones (DCA)</h3>
                            <button id="btn-add-dca" class="px-3 py-1 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700 text-lg">+</button>
                        </div>
                        <div id="dca-list" class="space-y-2"></div>
                    </div>
                    <!-- Crisis -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Crisis de Mercado</h3>
                             <button id="btn-add-crisis" class="px-3 py-1 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700 text-lg">+</button>
                        </div>
                        <div id="crisis-list" class="space-y-2"></div>
                    </div>
                     <!-- Rebalanceos -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Rebalanceos de Cartera</h3>
                            <button id="btn-add-rebalance" class="px-3 py-1 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700 text-lg">+</button>
                        </div>
                        <div id="rebalance-list" class="space-y-2"></div>
                    </div>
                </div>

            </div>

            <!-- Columna de Resultados -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">Evolución del Patrimonio y Resumen</h2>
                    
                    <div class="my-4">
                         <label for="observations" class="block mb-2 text-sm font-medium text-gray-700">Observaciones de la Simulación</label>
                         <textarea id="observations" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Anota aquí los detalles, hipótesis y conclusiones de este escenario..."></textarea>
                    </div>

                    <div class="relative h-[400px] md:h-[500px]">
                         <canvas id="investment-chart"></canvas>
                    </div>
                    
                    <!-- MODIFICADO: Resumen en dos columnas -->
                    <div id="results-summary" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                        <!-- Contenido generado por JS -->
                    </div>

                    <div id="table-section" class="mt-8 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">Resumen Anual Detallado</h2>
                        <div class="table-container">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Año</th>
                                        <th scope="col" class="px-6 py-3">Patrimonio Total</th>
                                        <th scope="col" class="px-6 py-3 text-center">RF %</th>
                                        <th scope="col" class="px-6 py-3 text-center">RV %</th>
                                        <th scope="col" class="px-6 py-3 text-center">REITs %</th>
                                        <th scope="col" class="px-6 py-3 text-center">Oro %</th>
                                        <th scope="col" class="px-6 py-3 text-center">Crypto %</th>
                                        <th scope="col" class="px-6 py-3 text-center">Ahorro %</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body">
                                    <!-- Filas generadas por JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="dca-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Añadir Aportación (DCA)</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="dca-ano" class="block mb-2 text-sm font-medium text-gray-700">Año de Inicio</label>
                        <input type="number" id="dca-ano" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="0" value="1">
                    </div>
                    <div>
                        <label for="dca-mes" class="block mb-2 text-sm font-medium text-gray-700">Mes de Inicio</label>
                        <input type="number" id="dca-mes" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="1" max="12" value="1">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="dca-duracion" class="block mb-2 text-sm font-medium text-gray-700">Duración (meses)</label>
                        <input type="number" id="dca-duracion" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" value="18" min="1">
                    </div>
                    <div>
                        <label for="dca-cantidad" class="block mb-2 text-sm font-medium text-gray-700">Cantidad Mensual (€)</label>
                        <input type="number" id="dca-cantidad" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" value="300">
                    </div>
                </div>
                <hr>
                <p class="font-semibold text-gray-700">Distribución de la aportación (%):</p>
                <div class="grid grid-cols-3 gap-x-4 gap-y-2" id="dca-pct-inputs">
                    <!-- Inputs de % generados por JS -->
                </div>
                <p id="dca-pct-error" class="text-red-500 text-sm hidden">Los porcentajes deben sumar 100.</p>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="dca-cancel" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button id="dca-save" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="crisis-modal" class="modal">
         <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Añadir Crisis de Mercado</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="crisis-ano" class="block mb-2 text-sm font-medium text-gray-700">Año</label>
                        <input type="number" id="crisis-ano" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="0" value="5">
                    </div>
                     <div>
                        <label for="crisis-mes" class="block mb-2 text-sm font-medium text-gray-700">Mes</label>
                        <input type="number" id="crisis-mes" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="1" max="12" value="3">
                    </div>
                </div>
                <p class="font-semibold text-gray-700">Caída de activos de riesgo (%):</p>
                <div class="grid grid-cols-3 gap-4" id="crisis-pct-inputs">
                    <!-- Inputs de % generados por JS -->
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="crisis-cancel" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button id="crisis-save" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>

    <div id="rebalance-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Añadir Rebalanceo de Cartera</h3>
             <div class="space-y-4">
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="rebalance-ano" class="block mb-2 text-sm font-medium text-gray-700">Año</label>
                        <input type="number" id="rebalance-ano" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="0" value="10">
                    </div>
                     <div>
                        <label for="rebalance-mes" class="block mb-2 text-sm font-medium text-gray-700">Mes</label>
                        <input type="number" id="rebalance-mes" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" min="1" max="12" value="1">
                    </div>
                </div>
                <hr>
                <p class="font-semibold text-gray-700">Nuevos porcentajes objetivo (%):</p>
                 <div class="grid grid-cols-3 gap-x-4 gap-y-2" id="rebalance-pct-inputs">
                    <!-- Inputs de % generados por JS -->
                </div>
                <p id="rebalance-pct-error" class="text-red-500 text-sm hidden">Los porcentajes deben sumar 100.</p>
             </div>
             <div class="flex justify-end mt-6 space-x-3">
                <button id="rebalance-cancel" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button id="rebalance-save" class="px-4 py-2 rounded-lg font-semibold text-white transition-colors duration-200 bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- CONFIGURACIÓN INICIAL Y CONSTANTES ---
        const ASSET_KEYS = ['rf', 'rv', 'reit', 'oro', 'crypto', 'ahorro'];
        const ASSET_NAMES = {
            rf: 'Renta Fija', rv: 'Renta Variable', reit: 'REITs',
            oro: 'Oro', crypto: 'Cryptos', ahorro: 'Ahorro'
        };
        const ASSET_COLORS = {
            rf: 'rgba(54, 162, 235, 0.8)', rv: 'rgba(255, 99, 132, 0.8)',
            reit: 'rgba(255, 159, 64, 0.8)', oro: 'rgba(255, 206, 86, 0.8)',
            crypto: 'rgba(153, 102, 255, 0.8)', ahorro: 'rgba(75, 192, 192, 0.8)',
            total: 'rgba(0, 0, 0, 1)'
        };
        const SCENARIOS = {
            manual: {},
            negativo: {
                growth: { rf: 1.5, rv: 5.0, reit: 4.5, oro: 3.5, crypto: 10.0, ahorro: 0.5 },
                crises: [
                    { id: Date.now() + 1, year: 4, month: 3, drops: { rv: 35, reit: 30, crypto: 60 }, auto: true },
                    { id: Date.now() + 2, year: 12, month: 9, drops: { rv: 25, reit: 20, crypto: 40 }, auto: true }
                ]
            },
            neutro: {
                growth: { rf: 2.5, rv: 7.5, reit: 6.5, oro: 3.0, crypto: 15.0, ahorro: 1.0 },
                crises: [
                    { id: Date.now() + 3, year: 7, month: 6, drops: { rv: 25, reit: 20, crypto: 45 }, auto: true }
                ]
            },
            positivo: {
                growth: { rf: 3.0, rv: 9.5, reit: 8.0, oro: 4.0, crypto: 25.0, ahorro: 1.5 },
                crises: []
            }
        };

        // Almacenamiento de eventos
        let dcaPlans = [];
        let crises = [];
        let rebalances = [];
        let editingEventId = null;

        // Referencias al DOM
        const resultsSummary = document.getElementById('results-summary');
        const scenarioSelect = document.getElementById('scenario-select');
        const observationsTextarea = document.getElementById('observations');

        // --- GENERACIÓN DINÁMICA DE INPUTS ---
        const generateInputs = () => {
            const patrimonioContainer = document.getElementById('patrimonio-inputs');
            const dcaContainer = document.getElementById('dca-pct-inputs');
            const crisisContainer = document.getElementById('crisis-pct-inputs');
            const rebalanceContainer = document.getElementById('rebalance-pct-inputs');

            patrimonioContainer.innerHTML = ASSET_KEYS.map(key => `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="${key}-inicial" class="block mb-2 text-sm font-medium text-gray-700">${ASSET_NAMES[key]} (€)</label>
                        <input type="number" id="${key}-inicial" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="0">
                    </div>
                    <div>
                        <label for="${key}-crecimiento" class="block mb-2 text-sm font-medium text-gray-700">Crec. Anual (%)</label>
                        <input type="number" id="${key}-crecimiento" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="0" step="0.1">
                    </div>
                </div>
            `).join('');

            dcaContainer.innerHTML = ASSET_KEYS.map(key => `
                <div><label for="dca-${key}-pct" class="block text-sm font-medium text-gray-700 text-center">${ASSET_NAMES[key]}</label>
                <input type="number" id="dca-${key}-pct" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 text-center" value="0" min="0" max="100"></div>
            `).join('');
            
            rebalanceContainer.innerHTML = ASSET_KEYS.map(key => `
                 <div><label for="rebalance-${key}-pct" class="block text-sm font-medium text-gray-700 text-center">${ASSET_NAMES[key]}</label>
                 <input type="number" id="rebalance-${key}-pct" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 text-center" value="0" min="0" max="100"></div>
            `).join('');
            
            crisisContainer.innerHTML = ['rv', 'reit', 'crypto'].map(key => `
                 <div><label for="crisis-caida-${key}" class="block mb-2 text-sm font-medium text-gray-700">${ASSET_NAMES[key]}</label>
                 <input type="number" id="crisis-caida-${key}" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="0" min="0" max="100"></div>
            `).join('');
            
            document.querySelectorAll('[id$="-crecimiento"]').forEach(input => {
                input.addEventListener('input', () => {
                    if (scenarioSelect.value !== 'manual') {
                        scenarioSelect.value = 'manual';
                    }
                });
            });
        };
        generateInputs();

        // --- CHART.JS ---
        const ctx = document.getElementById('investment-chart').getContext('2d');
        let investmentChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(v) } }, x: { title: { display: true, text: 'Años' } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(c.parsed.y)}` } } } } });

        // --- LÓGICA DE SIMULACIÓN (DEBOUNCED) ---
        let debounceTimer;
        const debouncedRunSimulation = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                runSimulation();
                saveState();
            }, 300);
        };

        // --- GESTIÓN DE ESTADO (LOCALSTORAGE) ---
        const saveState = () => {
            const state = {
                inputs: {},
                dcaPlans, crises, rebalances,
                scenario: scenarioSelect.value,
                observations: observationsTextarea.value
            };
            document.querySelectorAll('#patrimonio-inputs input, #anos, #inflacion').forEach(input => { // MODIFICADO
                state.inputs[input.id] = input.value;
            });
            localStorage.setItem('investmentSimState', JSON.stringify(state));
        };

        const loadState = () => {
            const state = JSON.parse(localStorage.getItem('investmentSimState'));
            if (!state) return;

            Object.keys(state.inputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = state.inputs[id];
                }
            });
            
            dcaPlans = state.dcaPlans || [];
            crises = state.crises || [];
            rebalances = state.rebalances || [];
            scenarioSelect.value = state.scenario || 'manual';
            observationsTextarea.value = state.observations || '';

            renderDcaList();
            renderCrisisList();
            renderRebalanceList();
            handleScenarioChange(); 
        };
        
        // --- IMPORT/EXPORT ---
        document.getElementById('export-data').addEventListener('click', () => {
            const state = JSON.parse(localStorage.getItem('investmentSimState') || '{}');
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'simulacion_inversion.json';
            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });

        const importFileInput = document.getElementById('import-file-input');
        document.getElementById('import-data').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (event) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const state = JSON.parse(e.target.result);
                    localStorage.setItem('investmentSimState', JSON.stringify(state));
                    loadState();
                    debouncedRunSimulation();
                } catch (error) {
                    alert('Error al importar el archivo. Asegúrate de que es un archivo JSON válido exportado desde esta herramienta.');
                    console.error("Error parsing imported JSON:", error);
                }
            };
            reader.readAsText(event.target.files[0]);
            importFileInput.value = '';
        });

        // --- MANEJO DE ESCENARIOS ---
        const handleScenarioChange = () => {
            const scenario = scenarioSelect.value;
            crises = crises.filter(c => !c.auto);
            if (scenario !== 'manual') {
                const scenarioData = SCENARIOS[scenario];
                if (scenarioData.growth) {
                    ASSET_KEYS.forEach(key => {
                        document.getElementById(`${key}-crecimiento`).value = scenarioData.growth[key] || 0;
                    });
                }
                if (scenarioData.crises) {
                    crises.push(...JSON.parse(JSON.stringify(scenarioData.crises)));
                }
            }
            renderCrisisList();
            debouncedRunSimulation();
        };
        scenarioSelect.addEventListener('change', handleScenarioChange);

        // --- MANEJO DE MODALES Y EDICIÓN ---
        const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const closeModal = (modalId) => {
            editingEventId = null;
            document.getElementById(modalId).classList.remove('active');
        };

        const setupModal = (modalId, openBtnId, saveBtnId, cancelBtnId, saveCallback, openForEditCallback) => {
            const modal = document.getElementById(modalId);
            document.getElementById(openBtnId).addEventListener('click', () => {
                editingEventId = null;
                modal.querySelector('h3').textContent = modal.querySelector('h3').textContent.replace('Editar', 'Añadir');
                openForEditCallback(null);
                openModal(modalId);
            });
            document.getElementById(cancelBtnId).addEventListener('click', () => closeModal(modalId));
            document.getElementById(saveBtnId).addEventListener('click', () => { if(saveCallback()) { closeModal(modalId); } });
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modalId); });
        };
        
        const openDcaModalForEdit = (plan) => {
            document.getElementById('dca-ano').value = plan ? plan.startYear : 1;
            document.getElementById('dca-mes').value = plan ? plan.startMonth : 1;
            document.getElementById('dca-duracion').value = plan ? plan.duration : 18;
            document.getElementById('dca-cantidad').value = plan ? plan.amount : 300;
            ASSET_KEYS.forEach(key => {
                document.getElementById(`dca-${key}-pct`).value = plan ? plan.percentages[key] : 0;
            });
            document.getElementById('dca-pct-error').classList.add('hidden');
        };
        setupModal('dca-modal', 'btn-add-dca', 'dca-save', 'dca-cancel', () => {
            const errorEl = document.getElementById('dca-pct-error');
            const pcts = {}; ASSET_KEYS.forEach(key => { pcts[key] = parseFloat(document.getElementById(`dca-${key}-pct`).value) || 0; });
            const totalPct = Object.values(pcts).reduce((a, b) => a + b, 0);
            if (Math.abs(totalPct - 100) > 0.01) { errorEl.textContent = `Los porcentajes deben sumar 100 (actual: ${totalPct}).`; errorEl.classList.remove('hidden'); return false; }
            errorEl.classList.add('hidden');
            
            const newPlan = {
                id: editingEventId || Date.now(), startYear: parseInt(document.getElementById('dca-ano').value), startMonth: parseInt(document.getElementById('dca-mes').value),
                duration: parseInt(document.getElementById('dca-duracion').value), amount: parseFloat(document.getElementById('dca-cantidad').value), percentages: pcts,
            };
            
            if (editingEventId) {
                const index = dcaPlans.findIndex(p => p.id === editingEventId);
                dcaPlans[index] = newPlan;
            } else {
                dcaPlans.push(newPlan);
            }
            renderDcaList(); debouncedRunSimulation(); return true;
        }, openDcaModalForEdit);

        const openCrisisModalForEdit = (crisis) => {
            document.getElementById('crisis-ano').value = crisis ? crisis.year : 5;
            document.getElementById('crisis-mes').value = crisis ? crisis.month : 3;
            document.getElementById('crisis-caida-rv').value = crisis ? crisis.drops.rv : 0;
            document.getElementById('crisis-caida-reit').value = crisis ? crisis.drops.reit : 0;
            document.getElementById('crisis-caida-crypto').value = crisis ? crisis.drops.crypto : 0;
        };
        setupModal('crisis-modal', 'btn-add-crisis', 'crisis-save', 'crisis-cancel', () => {
            const newCrisis = {
                id: editingEventId || Date.now(), year: parseInt(document.getElementById('crisis-ano').value), month: parseInt(document.getElementById('crisis-mes').value),
                drops: { rv: parseFloat(document.getElementById('crisis-caida-rv').value) || 0, reit: parseFloat(document.getElementById('crisis-caida-reit').value) || 0, crypto: parseFloat(document.getElementById('crisis-caida-crypto').value) || 0 }
            };

            if (editingEventId) {
                const index = crises.findIndex(c => c.id === editingEventId);
                newCrisis.auto = false;
                crises[index] = newCrisis;
            } else {
                crises.push(newCrisis);
            }
            renderCrisisList(); debouncedRunSimulation(); return true;
        }, openCrisisModalForEdit);
        
        const openRebalanceModalForEdit = (rebalance) => {
            document.getElementById('rebalance-ano').value = rebalance ? rebalance.year : 10;
            document.getElementById('rebalance-mes').value = rebalance ? rebalance.month : 1;
            ASSET_KEYS.forEach(key => {
                document.getElementById(`rebalance-${key}-pct`).value = rebalance ? rebalance.percentages[key] : 0;
            });
            document.getElementById('rebalance-pct-error').classList.add('hidden');
        };
        setupModal('rebalance-modal', 'btn-add-rebalance', 'rebalance-save', 'rebalance-cancel', () => {
            const errorEl = document.getElementById('rebalance-pct-error');
            const pcts = {}; ASSET_KEYS.forEach(key => { pcts[key] = parseFloat(document.getElementById(`rebalance-${key}-pct`).value) || 0; });
            const totalPct = Object.values(pcts).reduce((a, b) => a + b, 0);
            if (Math.abs(totalPct - 100) > 0.01) { errorEl.textContent = `Los porcentajes deben sumar 100 (actual: ${totalPct}).`; errorEl.classList.remove('hidden'); return false; }
            errorEl.classList.add('hidden');

            const newRebalance = {
                id: editingEventId || Date.now(), year: parseInt(document.getElementById('rebalance-ano').value), month: parseInt(document.getElementById('rebalance-mes').value), percentages: pcts
            };
            if (editingEventId) {
                const index = rebalances.findIndex(r => r.id === editingEventId);
                rebalances[index] = newRebalance;
            } else {
                rebalances.push(newRebalance);
            }
            renderRebalanceList(); debouncedRunSimulation(); return true;
        }, openRebalanceModalForEdit);

        const renderDcaList = () => {
            const listEl = document.getElementById('dca-list');
            listEl.innerHTML = dcaPlans.map(p => `<div class="bg-gray-100 p-2 rounded-md text-sm flex justify-between items-center"><span>Año ${p.startYear}, Mes ${p.startMonth}: ${new Intl.NumberFormat('es-ES').format(p.amount)}€/mes (${p.duration}m)</span><div class="space-x-1"><button data-id="${p.id}" class="dca-edit px-2 py-1 rounded font-semibold text-white bg-blue-500 hover:bg-blue-600 text-xs">E</button><button data-id="${p.id}" class="dca-delete px-2 py-1 rounded font-semibold text-white bg-red-600 hover:bg-red-700 text-xs">X</button></div></div>`).join('');
            document.querySelectorAll('.dca-delete').forEach(btn => btn.addEventListener('click', (e) => { dcaPlans = dcaPlans.filter(p => p.id != e.target.dataset.id); renderDcaList(); debouncedRunSimulation(); }));
            document.querySelectorAll('.dca-edit').forEach(btn => btn.addEventListener('click', (e) => {
                editingEventId = parseInt(e.target.dataset.id);
                const plan = dcaPlans.find(p => p.id === editingEventId);
                document.getElementById('dca-modal').querySelector('h3').textContent = 'Editar Aportación (DCA)';
                openDcaModalForEdit(plan);
                openModal('dca-modal');
            }));
        };
        const renderCrisisList = () => {
             const listEl = document.getElementById('crisis-list');
            listEl.innerHTML = crises.map(c => `<div class="bg-gray-100 p-2 rounded-md text-sm flex justify-between items-center ${c.auto ? 'opacity-70' : ''}"><span>Año ${c.year}, Mes ${c.month}: Caída RV(${c.drops.rv}%), REITs(${c.drops.reit}%), Crypto(${c.drops.crypto}%) ${c.auto ? '(Auto)' : ''}</span><div class="space-x-1"><button data-id="${c.id}" class="crisis-edit px-2 py-1 rounded font-semibold text-white bg-blue-500 hover:bg-blue-600 text-xs">E</button><button data-id="${c.id}" class="crisis-delete px-2 py-1 rounded font-semibold text-white bg-red-600 hover:bg-red-700 text-xs">X</button></div></div>`).join('');
             document.querySelectorAll('.crisis-delete').forEach(btn => btn.addEventListener('click', (e) => { crises = crises.filter(c => c.id != e.target.dataset.id); renderCrisisList(); debouncedRunSimulation(); }));
             document.querySelectorAll('.crisis-edit').forEach(btn => btn.addEventListener('click', (e) => {
                editingEventId = parseInt(e.target.dataset.id);
                const crisis = crises.find(c => c.id === editingEventId);
                document.getElementById('crisis-modal').querySelector('h3').textContent = 'Editar Crisis de Mercado';
                openCrisisModalForEdit(crisis);
                openModal('crisis-modal');
             }));
        };
        const renderRebalanceList = () => {
            const listEl = document.getElementById('rebalance-list');
            listEl.innerHTML = rebalances.map(r => `<div class="bg-gray-100 p-2 rounded-md text-sm flex justify-between items-center"><span>Año ${r.year}, Mes ${r.month}: Rebalanceo</span><div class="space-x-1"><button data-id="${r.id}" class="rebalance-edit px-2 py-1 rounded font-semibold text-white bg-blue-500 hover:bg-blue-600 text-xs">E</button><button data-id="${r.id}" class="rebalance-delete px-2 py-1 rounded font-semibold text-white bg-red-600 hover:bg-red-700 text-xs">X</button></div></div>`).join('');
            document.querySelectorAll('.rebalance-delete').forEach(btn => btn.addEventListener('click', (e) => { rebalances = rebalances.filter(r => r.id != e.target.dataset.id); renderRebalanceList(); debouncedRunSimulation(); }));
            document.querySelectorAll('.rebalance-edit').forEach(btn => btn.addEventListener('click', (e) => {
                editingEventId = parseInt(e.target.dataset.id);
                const rebalance = rebalances.find(r => r.id === editingEventId);
                document.getElementById('rebalance-modal').querySelector('h3').textContent = 'Editar Rebalanceo de Cartera';
                openRebalanceModalForEdit(rebalance);
                openModal('rebalance-modal');
            }));
        };

        // --- LÓGICA DE SIMULACIÓN PRINCIPAL ---
        const runSimulation = () => {
            const initialPortfolio = {};
            const annualGrowth = {};
            ASSET_KEYS.forEach(key => {
                initialPortfolio[key] = parseFloat(document.getElementById(`${key}-inicial`).value) || 0;
                annualGrowth[key] = parseFloat(document.getElementById(`${key}-crecimiento`).value) || 0;
            });
            const simulationYears = parseInt(document.getElementById('anos').value) || 30;
            const inflationRate = parseFloat(document.getElementById('inflacion').value) || 2.5; // NUEVO
            
            const monthlyGrowth = {};
            ASSET_KEYS.forEach(key => { monthlyGrowth[key] = Math.pow(1 + annualGrowth[key] / 100, 1 / 12) - 1; });
            
            const totalMonths = simulationYears * 12;
            let portfolioHistory = [];
            let currentPortfolio = { ...initialPortfolio };
            
            for (let month = 0; month <= totalMonths; month++) {
                const currentYear = Math.floor(month / 12);
                const currentMonthInYear = (month % 12) + 1;

                if (month > 0) {
                    ASSET_KEYS.forEach(key => { currentPortfolio[key] *= (1 + monthlyGrowth[key]); });
                    dcaPlans.forEach(plan => { 
                        const startTotalMonth = plan.startYear * 12 + plan.startMonth;
                        const endTotalMonth = startTotalMonth + plan.duration;
                        if (month >= startTotalMonth && month < endTotalMonth) {
                             ASSET_KEYS.forEach(key => { currentPortfolio[key] += plan.amount * (plan.percentages[key] / 100); });
                        }
                    });
                    crises.forEach(crisis => { 
                        if (crisis.year === currentYear && crisis.month === currentMonthInYear) {
                            currentPortfolio.rv *= (1 - crisis.drops.rv / 100);
                            currentPortfolio.reit *= (1 - crisis.drops.reit / 100);
                            currentPortfolio.crypto *= (1 - crisis.drops.crypto / 100);
                        }
                    });
                    rebalances.forEach(rebalance => { 
                         if (rebalance.year === currentYear && rebalance.month === currentMonthInYear) {
                            const totalValue = Object.values(currentPortfolio).reduce((a,b) => a+b, 0);
                            ASSET_KEYS.forEach(key => { currentPortfolio[key] = totalValue * (rebalance.percentages[key] / 100); });
                        }
                    });
                }
                
                const totalValue = Object.values(currentPortfolio).reduce((a, b) => a + b, 0);
                portfolioHistory.push({ ...currentPortfolio, total: totalValue });
            }

            renderResults(portfolioHistory, simulationYears, inflationRate); // MODIFICADO
        };
        
        // --- RENDERIZADO DE RESULTADOS (Gráfico y Tabla) ---
        const renderResults = (history, years, inflationRate) => { // MODIFICADO
            const labels = Array.from({ length: years + 1 }, (_, i) => i);
            const yearlyData = labels.map(year => history[year * 12]);
            const finalValue = history[history.length - 1].total;
            // NUEVO: Cálculo del valor ajustado a la inflación
            const adjustedFinalValue = finalValue / Math.pow(1 + inflationRate / 100, years);

            investmentChart.data.labels = labels;
            investmentChart.data.datasets = [
                { label: 'Patrimonio Total', data: yearlyData.map(p => p.total), borderColor: ASSET_COLORS.total, borderWidth: 3, tension: 0.1 },
                ...ASSET_KEYS.map(key => ({
                    label: ASSET_NAMES[key], data: yearlyData.map(p => p[key]), borderColor: ASSET_COLORS[key],
                    borderWidth: 1.5,
                    hidden: false,
                }))
            ];
            investmentChart.update();
            
            // MODIFICADO: Resumen con valor ajustado a la inflación
            resultsSummary.innerHTML = `
                <div>
                    <p class="text-lg">Después de <span class="font-bold">${years}</span> años, tu patrimonio estimado es:</p>
                    <p class="text-4xl font-bold text-blue-700 mt-2">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(finalValue)}</p>
                </div>
                <div class="border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                    <p class="text-lg">Tu patrimonio ajustado a la inflación del <span class="font-bold">${inflationRate}%</span> es:</p>
                    <p class="text-4xl font-bold text-green-700 mt-2">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(adjustedFinalValue)}</p>
                </div>
            `;

            const tableBody = document.getElementById('summary-table-body');
            const tableSection = document.getElementById('table-section');
            if (yearlyData.length > 1) {
                tableBody.innerHTML = yearlyData.map((data, year) => {
                    const total = data.total || 1;
                    const percentages = ASSET_KEYS.map(key => `
                        <td class="px-6 py-4 text-center">${((data[key] / total) * 100).toFixed(1)}%</td>
                    `).join('');
                    return `
                        <tr class="bg-white border-b">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${year}</th>
                            <td class="px-6 py-4 font-bold">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(data.total)}</td>
                            ${percentages}
                        </tr>
                    `;
                }).join('');
                tableSection.classList.remove('hidden');
            } else {
                tableSection.classList.add('hidden');
            }
        };

        // --- INICIALIZACIÓN ---
        document.querySelectorAll('input, select, textarea').forEach(el => el.addEventListener('input', debouncedRunSimulation));
        loadState();
        debouncedRunSimulation();
    });
    </script>

</body>
</html>

