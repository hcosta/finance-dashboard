<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Estrat√©gico a Largo Plazo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem; width: 100%; max-width: 32rem; transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-700">Simulador Estrat√©gico</h1>
            <p class="text-gray-600 mt-2">Proyecta el impacto a largo plazo de tu sistema de inversi√≥n.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Controles -->
            <div class="lg:col-span-1 space-y-6">
                 <!-- Escenarios -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-indigo-500">Escenario y Datos</h2>
                    <select id="scenario-select" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                        <option value="manual">Manual</option>
                        <option value="negativo">Negativo ("D√©cada Perdida")</option>
                        <option value="neutro">Neutro ("Crecimiento Estable")</option>
                        <option value="positivo">Positivo ("Mercado Alcista")</option>
                    </select>
                    <div class="flex space-x-2 mt-4">
                        <button id="export-data" class="w-full px-4 py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 text-sm">Exportar</button>
                        <button id="import-data" class="w-full px-4 py-2 rounded-lg font-semibold text-white bg-gray-600 hover:bg-gray-700 text-sm">Importar</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>

                <!-- Patrimonio Inicial -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-indigo-500">Patrimonio Inicial y Crecimiento</h2>
                    <div id="patrimonio-inputs" class="space-y-4">
                        <!-- Campos generados por JS -->
                    </div>
                </div>

                <!-- Par√°metros de Simulaci√≥n -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-indigo-500">Par√°metros de Simulaci√≥n</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="anos" class="block mb-2 text-sm font-medium text-gray-700">A√±os a Simular</label>
                            <input type="number" id="anos" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5" value="30">
                        </div>
                        <div>
                            <label for="inflacion" class="block mb-2 text-sm font-medium text-gray-700">Inflaci√≥n Anual Media (%)</label>
                            <input type="number" id="inflacion" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5" value="2.5" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Eventos -->
                <div class="space-y-6">
                    <!-- Aportaciones DCA -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Aportaciones Peri√≥dicas</h3>
                            <button id="btn-add-dca" class="px-3 py-1 rounded-lg font-semibold text-white transition-colors duration-200 bg-indigo-600 hover:bg-indigo-700 text-lg">+</button>
                        </div>
                        <div id="dca-list" class="space-y-2"></div>
                    </div>
                    <!-- Gesti√≥n de Crisis -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Gesti√≥n de Crisis (Algoritmo)</h3>
                             <button id="btn-add-crisis" class="px-3 py-1 rounded-lg font-semibold text-white transition-colors duration-200 bg-indigo-600 hover:bg-indigo-700 text-lg">+</button>
                        </div>
                        <div id="crisis-list" class="space-y-2"></div>
                    </div>
                </div>

            </div>

            <!-- Columna de Resultados -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                     <div class="relative h-[500px]">
                         <canvas id="investment-chart"></canvas>
                    </div>
                    <div id="results-summary" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                        <!-- Contenido generado por JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="dca-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">A√±adir Aportaci√≥n</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="dca-ano" class="block mb-2 text-sm font-medium text-gray-700">A√±o de Inicio</label>
                        <input type="number" id="dca-ano" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" min="0" value="1">
                    </div>
                    <div>
                        <label for="dca-duracion" class="block mb-2 text-sm font-medium text-gray-700">Duraci√≥n (meses)</label>
                        <input type="number" id="dca-duracion" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" min="1" value="120">
                    </div>
                </div>
                <div>
                    <label for="dca-cantidad" class="block mb-2 text-sm font-medium text-gray-700">Cantidad Mensual (‚Ç¨)</label>
                    <input type="number" id="dca-cantidad" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="500">
                </div>
                <div>
                    <label for="dca-source" class="block mb-2 text-sm font-medium text-gray-700">Origen del Capital</label>
                    <select id="dca-source" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                        <option value="nuevos_ahorros">Nuevos Ahorros</option>
                        <option value="polvora">P√≥lvora Seca</option>
                        <option value="rf">Renta Fija (con 20% imp.)</option>
                        <option value="metales">Metales (con 20% imp.)</option>
                    </select>
                </div>
                <hr>
                <p class="font-semibold text-gray-700">Distribuci√≥n de la aportaci√≥n (%):</p>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2" id="dca-pct-inputs">
                    <!-- Inputs de % generados por JS -->
                </div>
                <p id="dca-pct-error" class="text-red-500 text-sm hidden">Los porcentajes deben sumar 100.</p>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="dca-cancel" class="px-4 py-2 rounded-lg font-semibold text-white bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button id="dca-save" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="crisis-modal" class="modal">
         <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Simular Gesti√≥n de Crisis (MMS200)</h3>
            <div class="space-y-4">
                <div>
                    <label for="crisis-ano" class="block mb-2 text-sm font-medium text-gray-700">A√±o de la Venta (Se√±al üî¥)</label>
                    <input type="number" id="crisis-ano" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" min="0" value="5">
                </div>
                <div>
                    <label for="crisis-loss" class="block mb-2 text-sm font-medium text-gray-700">P√©rdida Inicial RV ("Prima del Seguro", %)</label>
                    <input type="number" id="crisis-loss" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="8" min="0" max="100">
                </div>
                <div>
                    <label for="crisis-loss-crypto" class="block mb-2 text-sm font-medium text-gray-700">Ca√≠da Adicional Crypto (%, sobre RV)</label>
                    <input type="number" id="crisis-loss-crypto" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="100" min="0" max="500">
                </div>
                 <div>
                    <label for="crisis-out" class="block mb-2 text-sm font-medium text-gray-700">Meses Fuera del Mercado (en P√≥lvora Seca)</label>
                    <input type="number" id="crisis-out" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="15" min="1">
                </div>
                 <div>
                    <label for="crisis-dca" class="block mb-2 text-sm font-medium text-gray-700">Meses para Re-invertir (DCA de re-entrada)</label>
                    <input type="number" id="crisis-dca" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" value="10" min="1">
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="crisis-cancel" class="px-4 py-2 rounded-lg font-semibold text-white bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button id="crisis-save" class="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700">Guardar</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ASSET_KEYS = ['polvora', 'rf', 'rv', 'metales', 'crypto', 'inmuebles'];
    const ASSET_NAMES = {
        polvora: 'P√≥lvora Seca', rf: 'Renta Fija', rv: 'Renta Variable', metales: 'Metales', crypto: 'Crypto (BTC)', inmuebles: 'Inmuebles'
    };
    const ASSET_COLORS = {
        polvora: 'rgba(153, 102, 255, 0.8)', rf: 'rgba(54, 162, 235, 0.8)', rv: 'rgba(255, 99, 132, 0.8)',
        metales: 'rgba(255, 206, 86, 0.8)', crypto: 'rgba(255, 159, 64, 0.8)', inmuebles: 'rgba(75, 192, 192, 0.8)',
        total: 'rgba(0, 0, 0, 1)', contributed: 'rgba(100, 100, 100, 0.7)'
    };
     const SCENARIOS = {
        manual: {},
        negativo: {
            growth: { polvora: 0.75, rf: 1.5, rv: 5.5, metales: 3.0, crypto: 6.0, inmuebles: 1.0 },
            crisisManagements: [ { id: Date.now() + 1, year: 2, initialLoss: 8, monthsOut: 18, dcaMonths: 10, cryptoLoss: 100, auto: true },
                                 { id: Date.now() + 2, year: 9, initialLoss: 10, monthsOut: 18, dcaMonths: 10, cryptoLoss: 100, auto: true } ]
        },
        neutro: {
            growth: { polvora: 0.75, rf: 2.0, rv: 7.0, metales: 4.0, crypto: 10.0, inmuebles: 2.0 },
            crisisManagements: [ { id: Date.now() + 3, year: 10, initialLoss: 10, monthsOut: 12, dcaMonths: 10, cryptoLoss: 100, auto: true } ]
        },
        positivo: {
            growth: { polvora: 0.75, rf: 2.5, rv: 9.0, metales: 5.0, crypto: 13.0, inmuebles: 3.0 },
            crisisManagements: []
        }
    };

    let dcaPlans = [];
    let crisisManagements = [];
    let editingEventId = null;

    const resultsSummary = document.getElementById('results-summary');
    const scenarioSelect = document.getElementById('scenario-select');

    const generateInputs = () => {
        const patrimonioContainer = document.getElementById('patrimonio-inputs');
        const dcaContainer = document.getElementById('dca-pct-inputs');
        
        const defaultValues = { polvora: 10000, rf: 10000, rv: 10000, metales: 10000, crypto: 13000, inmuebles: 30000 };
        const defaultGrowth = { polvora: 0.75, rf: 2, rv: 7, metales: 4, crypto: 15, inmuebles: 3 };

        patrimonioContainer.innerHTML = ASSET_KEYS.map(key => {
            const isReadonly = key === 'crypto' || key === 'inmuebles';
            return `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="${key}-inicial" class="block mb-2 text-sm font-medium text-gray-700">${ASSET_NAMES[key]} (‚Ç¨)</label>
                    <input type="number" id="${key}-inicial" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 ${isReadonly ? 'cursor-not-allowed' : ''}" 
                           value="${defaultValues[key] || 0}" ${isReadonly ? 'readonly' : ''}>
                </div>
                <div>
                    <label for="${key}-crecimiento" class="block mb-2 text-sm font-medium text-gray-700">Crec. Anual (%)</label>
                    <input type="number" id="${key}-crecimiento" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5" 
                           value="${defaultGrowth[key] || 0}" step="0.1">
                </div>
            </div>
        `}).join('');

        dcaContainer.innerHTML = ASSET_KEYS.map(key => {
             const isReadonly = key === 'crypto' || key === 'inmuebles';
             return `
            <div><label for="dca-${key}-pct" class="block text-sm font-medium text-gray-700 text-center ${isReadonly ? 'text-gray-400' : ''}">${ASSET_NAMES[key]}</label>
            <input type="number" id="dca-${key}-pct" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 text-center" 
                   value="0" min="0" max="100" ${isReadonly ? 'readonly' : ''}></div>
        `}).join('');

        document.querySelectorAll('[id$="-crecimiento"]').forEach(input => {
            input.addEventListener('input', () => {
                if (scenarioSelect.value !== 'manual') {
                    scenarioSelect.value = 'manual';
                    handleScenarioChange();
                }
            });
        });
    };
    generateInputs();

    const ctx = document.getElementById('investment-chart').getContext('2d');
    let investmentChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(v) } }, x: { title: { display: true, text: 'A√±os' } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(c.parsed.y)}` } } } } });

    let debounceTimer;
    const debouncedRunSimulation = () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            runSimulation();
            saveState();
        }, 300);
    };

    // --- GESTI√ìN DE ESTADO (LOCALSTORAGE, IMPORT/EXPORT) ---
    const saveState = () => {
        const state = {
            inputs: {},
            dcaPlans, crisisManagements,
            scenario: scenarioSelect.value
        };
        document.querySelectorAll('#patrimonio-inputs input, #anos, #inflacion').forEach(input => {
            if(!input.readOnly) {
                 state.inputs[input.id] = input.value;
            }
        });
        localStorage.setItem('strategicSimState', JSON.stringify(state));
    };

    const loadState = (state) => {
        if (!state) return;

        if (state.inputs) {
            Object.keys(state.inputs).forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.readOnly) input.value = state.inputs[id];
            });
        }
        
        dcaPlans = state.dcaPlans || [];
        crisisManagements = state.crisisManagements || [];
        scenarioSelect.value = state.scenario || 'manual';

        renderDcaList();
        renderCrisisList();
        debouncedRunSimulation();
    };

    document.getElementById('export-data').addEventListener('click', () => {
        saveState(); 
        const state = localStorage.getItem('strategicSimState');
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(state);
        const exportFileDefaultName = 'simulacion_estrategica.json';
        let linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    });

    const importFileInput = document.getElementById('import-file-input');
    document.getElementById('import-data').addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (event) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const state = JSON.parse(e.target.result);
                loadState(state);
            } catch (error) {
                alert('Error al importar el archivo.');
                console.error("Error parsing imported JSON:", error);
            }
        };
        reader.readAsText(event.target.files[0]);
        importFileInput.value = '';
    });
    
    const handleScenarioChange = () => {
        const scenario = scenarioSelect.value;
        crisisManagements = crisisManagements.filter(c => !c.auto);
        if (scenario !== 'manual') {
            const scenarioData = SCENARIOS[scenario];
            if (scenarioData.growth) {
                ASSET_KEYS.forEach(key => {
                    document.getElementById(`${key}-crecimiento`).value = scenarioData.growth[key] || 0;
                });
            }
            if (scenarioData.crisisManagements) {
                crisisManagements.push(...JSON.parse(JSON.stringify(scenarioData.crisisManagements)));
            }
        }
        renderCrisisList();
        debouncedRunSimulation();
    };
    scenarioSelect.addEventListener('change', handleScenarioChange);


    const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
    const closeModal = (modalId) => {
        editingEventId = null;
        document.getElementById(modalId).classList.remove('active');
    };

    // --- MODAL DCA ---
    document.getElementById('btn-add-dca').addEventListener('click', () => {
        editingEventId = null;
        document.getElementById('dca-modal').querySelector('h3').textContent = 'A√±adir Aportaci√≥n';
        openDcaModalForEdit(null);
        openModal('dca-modal');
    });
    document.getElementById('dca-cancel').addEventListener('click', () => closeModal('dca-modal'));
    document.getElementById('dca-save').addEventListener('click', () => {
        const errorEl = document.getElementById('dca-pct-error');
        const pcts = {}; 
        ASSET_KEYS.forEach(key => { 
            const input = document.getElementById(`dca-${key}-pct`);
            if (input && !input.readOnly) pcts[key] = parseFloat(input.value) || 0; 
        });
        const totalPct = Object.values(pcts).reduce((a, b) => a + b, 0);
        if (Math.abs(totalPct - 100) > 0.01) { errorEl.classList.remove('hidden'); return; }
        errorEl.classList.add('hidden');
        
        const newPlan = {
            id: editingEventId || Date.now(),
            startYear: parseInt(document.getElementById('dca-ano').value),
            duration: parseInt(document.getElementById('dca-duracion').value),
            amount: parseFloat(document.getElementById('dca-cantidad').value),
            source: document.getElementById('dca-source').value,
            percentages: {...pcts, crypto: 0, inmuebles: 0},
        };
        
        if (editingEventId) dcaPlans[dcaPlans.findIndex(p => p.id === editingEventId)] = newPlan;
        else dcaPlans.push(newPlan);
        
        renderDcaList(); debouncedRunSimulation(); closeModal('dca-modal');
    });
    
    function openDcaModalForEdit(plan) {
        document.getElementById('dca-ano').value = plan ? plan.startYear : 1;
        document.getElementById('dca-duracion').value = plan ? plan.duration : 120;
        document.getElementById('dca-cantidad').value = plan ? plan.amount : 500;
        document.getElementById('dca-source').value = plan ? plan.source : 'nuevos_ahorros';
        ASSET_KEYS.forEach(key => {
            const input = document.getElementById(`dca-${key}-pct`);
            if (input) input.value = plan?.percentages[key] || 0;
        });
        document.getElementById('dca-pct-error').classList.add('hidden');
    }

    // --- MODAL CRISIS ---
    document.getElementById('btn-add-crisis').addEventListener('click', () => {
        editingEventId = null;
        document.getElementById('crisis-modal').querySelector('h3').textContent = 'Simular Gesti√≥n de Crisis';
        openCrisisModalForEdit(null);
        openModal('crisis-modal');
    });
    document.getElementById('crisis-cancel').addEventListener('click', () => closeModal('crisis-modal'));
    document.getElementById('crisis-save').addEventListener('click', () => {
        const newCrisis = {
            id: editingEventId || Date.now(), 
            year: parseInt(document.getElementById('crisis-ano').value), 
            initialLoss: parseFloat(document.getElementById('crisis-loss').value),
            cryptoLoss: parseFloat(document.getElementById('crisis-loss-crypto').value),
            monthsOut: parseInt(document.getElementById('crisis-out').value),
            dcaMonths: parseInt(document.getElementById('crisis-dca').value)
        };
        if (editingEventId) crisisManagements[crisisManagements.findIndex(c => c.id === editingEventId)] = newCrisis;
        else crisisManagements.push(newCrisis);

        renderCrisisList(); debouncedRunSimulation(); closeModal('crisis-modal');
    });

    function openCrisisModalForEdit(crisis) {
        document.getElementById('crisis-ano').value = crisis ? crisis.year : 5;
        document.getElementById('crisis-loss').value = crisis ? crisis.initialLoss : 8;
        document.getElementById('crisis-loss-crypto').value = crisis ? crisis.cryptoLoss : 100;
        document.getElementById('crisis-out').value = crisis ? crisis.monthsOut : 15;
        document.getElementById('crisis-dca').value = crisis ? crisis.dcaMonths : 10;
    }

    const renderDcaList = () => {
        const listEl = document.getElementById('dca-list');
        listEl.innerHTML = dcaPlans.map(p => {
            const sourceText = {
                nuevos_ahorros: "N. Ahorros", polvora: "P√≥lvora", rf: "RF", metales: "Metales"
            }[p.source] || "N/A";
            return `<div class="bg-gray-100 p-2 rounded-md text-sm flex justify-between items-center"><span>A√±o ${p.startYear}: ${new Intl.NumberFormat('es-ES').format(p.amount)}‚Ç¨/m (${p.duration}m) desde ${sourceText}</span><div class="space-x-1"><button data-id="${p.id}" class="dca-edit px-2 py-1 rounded font-semibold text-white bg-blue-500 hover:bg-blue-600 text-xs">E</button><button data-id="${p.id}" class="dca-delete px-2 py-1 rounded font-semibold text-white bg-red-600 hover:bg-red-700 text-xs">X</button></div></div>`;
        }).join('');
        document.querySelectorAll('.dca-delete').forEach(btn => btn.addEventListener('click', (e) => { dcaPlans = dcaPlans.filter(p => p.id != e.target.dataset.id); renderDcaList(); debouncedRunSimulation(); }));
        document.querySelectorAll('.dca-edit').forEach(btn => btn.addEventListener('click', (e) => {
            editingEventId = parseInt(e.target.dataset.id);
            const plan = dcaPlans.find(p => p.id === editingEventId);
            document.getElementById('dca-modal').querySelector('h3').textContent = 'Editar Aportaci√≥n';
            openDcaModalForEdit(plan);
            openModal('dca-modal');
        }));
    };
    const renderCrisisList = () => {
        const listEl = document.getElementById('crisis-list');
        listEl.innerHTML = crisisManagements.map(c => `<div class="bg-gray-100 p-2 rounded-md text-sm flex justify-between items-center ${c.auto ? 'opacity-70' : ''}"><span>A√±o ${c.year}: Venta (-${c.initialLoss}% RV, -${(c.initialLoss * (1 + c.cryptoLoss / 100)).toFixed(0)}% C), ${c.monthsOut}m fuera, ${c.dcaMonths}m re-e ${c.auto ? '(Auto)' : ''}</span><div class="space-x-1"><button data-id="${c.id}" class="crisis-edit px-2 py-1 rounded font-semibold text-white bg-blue-500 hover:bg-blue-600 text-xs">E</button><button data-id="${c.id}" class="crisis-delete px-2 py-1 rounded font-semibold text-white bg-red-600 hover:bg-red-700 text-xs">X</button></div></div>`).join('');
        document.querySelectorAll('.crisis-delete').forEach(btn => btn.addEventListener('click', (e) => { crisisManagements = crisisManagements.filter(c => c.id != e.target.dataset.id); renderCrisisList(); debouncedRunSimulation(); }));
         document.querySelectorAll('.crisis-edit').forEach(btn => btn.addEventListener('click', (e) => {
            editingEventId = parseInt(e.target.dataset.id);
            const crisis = crisisManagements.find(c => c.id === editingEventId);
            document.getElementById('crisis-modal').querySelector('h3').textContent = 'Editar Gesti√≥n de Crisis';
            openCrisisModalForEdit(crisis);
            openModal('crisis-modal');
        }));
    };

    const runSimulation = () => {
        const initialPortfolio = {};
        ASSET_KEYS.forEach(key => {
            const initialValue = parseFloat(document.getElementById(`${key}-inicial`).value) || 0;
            initialPortfolio[key] = { value: initialValue, cost: initialValue };
        });

        const annualGrowth = {};
        ASSET_KEYS.forEach(key => { annualGrowth[key] = parseFloat(document.getElementById(`${key}-crecimiento`).value) || 0; });
        const simulationYears = parseInt(document.getElementById('anos').value) || 30;
        const inflationRate = parseFloat(document.getElementById('inflacion').value) || 2.5;
        
        const monthlyGrowth = {};
        ASSET_KEYS.forEach(key => { monthlyGrowth[key] = Math.pow(1 + annualGrowth[key] / 100, 1 / 12) - 1; });
        
        const totalMonths = simulationYears * 12;
        let portfolioHistory = [];
        let currentPortfolio = JSON.parse(JSON.stringify(initialPortfolio));
        let totalContributed = Object.values(initialPortfolio).reduce((acc, asset) => acc + asset.cost, 0);
        let crisisState = {};

        for (let month = 1; month <= totalMonths; month++) {
            const currentYear = Math.floor((month - 1) / 12);
            
            const growthFactors = {...monthlyGrowth};
            let inCrisisOutPeriod = false;
            Object.keys(crisisState).forEach(id => {
                const state = crisisState[id];
                if (state.active && month > state.startMonth && month <= state.reentryMonth) {
                    inCrisisOutPeriod = true;
                }
            });
            if (inCrisisOutPeriod) growthFactors.rv = 0; 

            ASSET_KEYS.forEach(key => { currentPortfolio[key].value *= (1 + growthFactors[key]); });
            
            dcaPlans.forEach(plan => { 
                const startTotalMonth = (plan.startYear - 1) * 12 + 1;
                const endTotalMonth = startTotalMonth + plan.duration -1;
                if (month >= startTotalMonth && month <= endTotalMonth) {
                    if (plan.source === 'nuevos_ahorros') {
                        totalContributed += plan.amount;
                        ASSET_KEYS.forEach(key => { 
                            const contribution = plan.amount * ((plan.percentages[key] || 0) / 100);
                            currentPortfolio[key].value += contribution;
                            currentPortfolio[key].cost += contribution;
                        });
                    } else { 
                        const sourceAssetKey = plan.source;
                        if(sourceAssetKey === 'crypto' || sourceAssetKey === 'inmuebles') return; // Cannot rebalance from these
                        
                        const sourceAsset = currentPortfolio[sourceAssetKey];
                        if (sourceAsset.value >= plan.amount) {
                            const originalValue = sourceAsset.value;
                            const originalCost = sourceAsset.cost;
                            const gainRatio = (originalValue > 0 && originalValue > originalCost) ? (originalValue - originalCost) / originalValue : 0;
                            const gainInTransfer = plan.amount * gainRatio;
                            const tax = (plan.source === 'rf' || plan.source === 'metales') && gainInTransfer > 0 ? gainInTransfer * 0.20 : 0;
                            const netAmount = plan.amount - tax;
                            sourceAsset.value -= plan.amount;
                            if (originalValue > 0) {
                                sourceAsset.cost -= plan.amount * (originalCost / originalValue);
                            }
                            ASSET_KEYS.forEach(key => {
                                const distribution = netAmount * ((plan.percentages[key] || 0) / 100);
                                currentPortfolio[key].value += distribution;
                                currentPortfolio[key].cost += distribution;
                            });
                        }
                    }
                }
            });

            crisisManagements.forEach(crisis => {
                if (currentYear === crisis.year - 1 && (month % 12) === 1 && !crisisState[crisis.id]) {
                    // Sell RV
                    const rvValue = currentPortfolio.rv.value;
                    const rvLossAmount = rvValue * (crisis.initialLoss / 100);
                    const rvCapitalToMove = rvValue - rvLossAmount;
                    currentPortfolio.rv.value = 0;
                    currentPortfolio.rv.cost = 0; 
                    currentPortfolio.polvora.value += rvCapitalToMove;
                    currentPortfolio.polvora.cost += rvCapitalToMove;
                    
                    // Crash Crypto
                    const cryptoDrop = crisis.initialLoss * (1 + (crisis.cryptoLoss / 100));
                    currentPortfolio.crypto.value *= (1 - cryptoDrop / 100);

                    crisisState[crisis.id] = {
                        active: true, capital: rvCapitalToMove, startMonth: month,
                        reentryMonth: month + crisis.monthsOut,
                        dcaStartMonth: month + crisis.monthsOut,
                        dcaEndMonth: month + crisis.monthsOut + crisis.dcaMonths - 1,
                        dcaAmount: rvCapitalToMove / crisis.dcaMonths
                    };
                }
            });

            Object.keys(crisisState).forEach(id => {
                const state = crisisState[id];
                if (state.active && month >= state.dcaStartMonth && month <= state.dcaEndMonth) {
                    const amountToMove = state.dcaAmount;
                    if (currentPortfolio.polvora.value >= amountToMove) {
                        currentPortfolio.polvora.value -= amountToMove;
                        const polvoraCostRatio = (currentPortfolio.polvora.value + amountToMove > 0) ? currentPortfolio.polvora.cost / (currentPortfolio.polvora.value + amountToMove) : 1;
                        currentPortfolio.polvora.cost -= amountToMove * polvoraCostRatio;
                        currentPortfolio.rv.value += amountToMove;
                        currentPortfolio.rv.cost += amountToMove;
                    }
                    if(month === state.dcaEndMonth) state.active = false; 
                }
            });
            
            const totalValue = ASSET_KEYS.reduce((acc, key) => acc + currentPortfolio[key].value, 0);
            portfolioHistory[month] = { portfolio: JSON.parse(JSON.stringify(currentPortfolio)), total: totalValue, contributed: totalContributed };
        }
        portfolioHistory[0] = { portfolio: JSON.parse(JSON.stringify(initialPortfolio)), total: Object.values(initialPortfolio).reduce((acc, asset) => acc + asset.value, 0), contributed: totalContributed };

        renderResults(portfolioHistory, simulationYears, inflationRate);
    };
    
    const renderResults = (history, years, inflationRate) => {
        const labels = Array.from({ length: years + 1 }, (_, i) => i);
        const yearlyData = history.length > 1 ? labels.map(year => history[year * 12]) : [history[0]];
        const finalValue = history[history.length - 1].total;
        const adjustedFinalValue = finalValue / Math.pow(1 + inflationRate / 100, years);

        investmentChart.data.labels = labels;
        investmentChart.data.datasets = [
            { label: 'Patrimonio Total', data: yearlyData.map(p => p.total), borderColor: ASSET_COLORS.total, borderWidth: 3, tension: 0.1 },
            { label: 'Inversi√≥n Aportada', data: yearlyData.map(p => p.contributed), borderColor: ASSET_COLORS.contributed, borderWidth: 2, borderDash: [5, 5], tension: 0.1, fill: false },
            ...ASSET_KEYS.map(key => ({
                label: ASSET_NAMES[key], data: yearlyData.map(p => p.portfolio[key].value), borderColor: ASSET_COLORS[key], borderWidth: 1.5, hidden: false,
            }))
        ];
        investmentChart.update();
        
        resultsSummary.innerHTML = `
            <div>
                <p class="text-lg">Patrimonio Final (tras ${years} a√±os):</p>
                <p class="text-4xl font-bold text-indigo-700 mt-2">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(finalValue)}</p>
            </div>
            <div class="border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                <p class="text-lg">Patrimonio ajustado a inflaci√≥n (${inflationRate}%):</p>
                <p class="text-4xl font-bold text-green-700 mt-2">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(adjustedFinalValue)}</p>
            </div>
        `;
    };

    // --- INITIALIZATION ---
    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', debouncedRunSimulation));
    
    const savedStateString = localStorage.getItem('strategicSimState');
    if (savedStateString) {
        try {
            const savedState = JSON.parse(savedStateString);
            loadState(savedState);
        } catch(e) {
            console.error("Could not parse saved state from localStorage", e);
            debouncedRunSimulation();
        }
    } else {
        debouncedRunSimulation();
    }
});
</script>

</body>
</html>

